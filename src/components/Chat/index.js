


// // // // import classNames from "classnames/bind";
// // // // import styles from "./Chat.module.scss";
// // // // import { useState, useEffect, useRef } from "react";
// // // // import ProFile1 from "~/pages/ProFile1";
// // // // import ChatPreview from "./ChatPreview";
// // // // import FriendRequestBar from "./FriendRequestBar";
// // // // import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
// // // // import ChatHeader from "./ChatHeader";
// // // // import axios from "axios";
// // // // import { io } from "socket.io-client";

// // // // const cx = classNames.bind(styles);

// // // // function Chat({ friend, onToggleDetail }) {
// // // //   const [open, setOpen] = useState(false);
// // // //   const [text, setText] = useState("");
// // // //   const [showProfile, setShowProFile] = useState(false);
// // // //   const [previewImage, setPreviewImage] = useState(null);
// // // //   const messagesContainerRef = useRef(null);
// // // //   const [messages, setMessages] = useState([]);
// // // //   const [loading, setLoading] = useState(true);
// // // //   const [error, setError] = useState(null);
// // // //   const [showSendRequestBar, setShowSendRequestBar] = useState(false);
// // // //   const socketRef = useRef(null);

// // // //   // H√†m cu·ªôn xu·ªëng cu·ªëi
// // // //   const scrollToBottom = () => {
// // // //     if (messagesContainerRef.current) {
// // // //       messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
// // // //     }
// // // //   };

// // // //   // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
// // // //   useEffect(() => {
// // // //     scrollToBottom();
// // // //   }, [messages]);

// // // //   // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
// // // //   useEffect(() => {
// // // //     if (friend?.sender) {
// // // //       socketRef.current = io("http://localhost:5000", {
// // // //         query: { userId: friend.sender },
// // // //       });

// // // //       socketRef.current.on("receiveMessage", (data) => {
// // // //         console.log("üì© Nh·∫≠n t·ª´", data.from, ":", data.message);

// // // //         const receivedMessage = {
// // // //           id: new Date() + Math.random(),
// // // //           text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
// // // //           type: data.message.sender !== friend.member ? "sent" : "received",
// // // //           timestamp: new Date(data.message.timestamp),
// // // //           image: data.message.message_type === "image" ? `http://localhost:5000${data.message.url}` : null,
// // // //           video: data.message.message_type === "video" ? `http://localhost:5000${data.message.url}` : null,
// // // //           file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
// // // //         };

// // // //         setMessages((prev) => [...prev, receivedMessage]);

// // // //         console.log("Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω:", receivedMessage);
// // // //       });

// // // //       return () => {
// // // //         if (socketRef.current) {
// // // //           socketRef.current.disconnect();
// // // //         }
// // // //       };
// // // //     }
// // // //   }, [friend?.sender]);

// // // //   // Fetch tin nh·∫Øn t·ª´ API
// // // //   useEffect(() => {
// // // //     console.log("useEffect fetchMessages ch·∫°y l·∫°i");
// // // //     const fetchMessages = async () => {
// // // //       if (!friend || !friend.id) {
// // // //         setMessages([]);
// // // //         setLoading(false);
// // // //         return;
// // // //       }

// // // //       try {
// // // //         const response = await axios.post("http://localhost:5000/api/chat/messages/", {
// // // //           friendId: friend.id,
// // // //         });

// // // //         if (response.status === 200 && Array.isArray(response.data)) {
// // // //           // Transform d·ªØ li·ªáu ƒë·ªÉ kh·ªõp c·∫•u tr√∫c component
// // // //           const transformedMessages = response.data
// // // //             .map((msg) => ({
// // // //               id: msg.id,
// // // //               text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
// // // //               type: msg.sender !== friend.member ? "sent" : "received",
// // // //               timestamp: new Date(msg.timestamp),
// // // //               image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
// // // //               video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
// // // //               file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
// // // //             }))
// // // //             .filter((msg) => msg.text || msg.image || msg.video || msg.file);

// // // //           console.log("Tin nh·∫Øn ƒë√£ chuy·ªÉn ƒë·ªïi:", transformedMessages);
// // // //           setMessages(transformedMessages);
// // // //         } else {
// // // //           setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
// // // //         }
// // // //       } catch (err) {
// // // //         setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
// // // //         console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
// // // //       } finally {
// // // //         setLoading(false);
// // // //       }
// // // //     };

// // // //     fetchMessages();
// // // //   }, [friend]);

// // // //   // H√†m toggle gi·ªØa RequestBar v√† ConfirmBar
// // // //   const toggleRequestBar = () => {
// // // //     setShowSendRequestBar((prev) => !prev);
// // // //   };

// // // //   const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

// // // //   const handleEmoji = (emoji) => {
// // // //     setText((prev) => prev + emoji);
// // // //     setOpen(false);
// // // //   };

// // // //   const handleSend = async () => {
// // // //     if (text.trim()) {
// // // //       const newMessage = {
// // // //         id: Date.now(),
// // // //         text: text.trim(),
// // // //         type: "sent",
// // // //         timestamp: new Date(),
// // // //       };
// // // //       setMessages((prev) => [...prev, newMessage]);
// // // //       setText("");

// // // //       if (socketRef.current) {
// // // //         socketRef.current.emit("sendMessage", {
// // // //           toUserId: friend.member,
// // // //           message: {
// // // //             id: "",
// // // //             conversation_id: friend.id,
// // // //             sender: friend.sender,
// // // //             recipient: friend.member,
// // // //             content: newMessage.text,
// // // //             message_type: "text",
// // // //             timestamp: new Date().toISOString(),
// // // //             url: null,
// // // //           },
// // // //         });
// // // //         console.log("üì§ G·ª≠i ƒë·∫øn", friend.member, ":", newMessage.text);
// // // //       }

// // // //       try {
// // // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // // //           id: "",
// // // //           conversationId: friend.id,
// // // //           sender: friend.sender,
// // // //           content: text.trim(),
// // // //           message_type: "text",
// // // //           timestamp: new Date().toISOString(),
// // // //           recipient: friend.member,
// // // //         });
// // // //       } catch (error) {
// // // //         console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
// // // //       }
// // // //     } else {
// // // //       const likeMessage = {
// // // //         id: Date.now(),
// // // //         text: "üëç",
// // // //         type: "sent",
// // // //         timestamp: new Date(),
// // // //       };
// // // //       setMessages((prev) => [...prev, likeMessage]);

// // // //       if (socketRef.current) {
// // // //         socketRef.current.emit("sendMessage", {
// // // //           toUserId: friend.member,
// // // //           message: {
// // // //             id: "",
// // // //             conversation_id: friend.id,
// // // //             sender: friend.sender,
// // // //             recipient: friend.member,
// // // //             content: "üëç",
// // // //             message_type: "text",
// // // //             timestamp: new Date().toISOString(),
// // // //             url: null,
// // // //           },
// // // //         });
// // // //         console.log("üì§ G·ª≠i ƒë·∫øn", friend.member, ": üëç");
// // // //       }

// // // //       try {
// // // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // // //           id: "",
// // // //           conversationId: friend.id,
// // // //           sender: friend.sender,
// // // //           content: "üëç",
// // // //           message_type: "text",
// // // //           timestamp: new Date().toISOString(),
// // // //           recipient: friend.member,
// // // //         });
// // // //       } catch (error) {
// // // //         console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
// // // //       }
// // // //     }
// // // //   };

// // // //   const handleKeyPress = (e) => {
// // // //     if (e.key === "Enter") {
// // // //       handleSend();
// // // //     }
// // // //   };

// // // //   const handleAvatarClick = () => {
// // // //     setShowProFile(true);
// // // //   };

// // // //   // H√†m x·ª≠ l√Ω ch·ªçn file media
// // // //   const handleMediaSelect = async (e, mediaType) => {
// // // //     const file = e.target.files[0];
// // // //     if (!file) {
// // // //       alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
// // // //       console.log("Kh√¥ng c√≥ t·ªáp ƒë∆∞·ª£c ch·ªçn.");
// // // //       return;
// // // //     }

// // // //     if (file.size > 50 * 1024 * 1024) {
// // // //       alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
// // // //       console.log("T·ªáp qu√° l·ªõn:", file.size);
// // // //       return;
// // // //     }

// // // //     if (mediaType === "image" && !file.type.startsWith("image/")) {
// // // //       alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
// // // //       console.log("T·ªáp kh√¥ng ph·∫£i h√¨nh ·∫£nh:", file.type);
// // // //       return;
// // // //     }

// // // //     if (mediaType === "video" && !file.type.startsWith("video/")) {
// // // //       alert("Vui l√≤ng ch·ªçn t·ªáp video.");
// // // //       console.log("T·ªáp kh√¥ng ph·∫£i video:", file.type);
// // // //       return;
// // // //     }

// // // //     // HI·ªÇN TH·ªä TR∆Ø·ªöC - T·∫°o preview local
// // // //     const reader = new FileReader();
// // // //     reader.onload = () => {
// // // //       console.log("FileReader onload, preview URL:", reader.result.substring(0, 50) + "...");

// // // //       const tempMessage = {
// // // //         id: Date.now() + Math.random(),
// // // //         type: "sent",
// // // //         timestamp: new Date(),
// // // //         uploading: true,
// // // //         fileName: file.name,
// // // //       };

// // // //       if (mediaType === "image") {
// // // //         tempMessage.image = reader.result;
// // // //       } else if (mediaType === "video") {
// // // //         tempMessage.video = reader.result;
// // // //       } else if (mediaType === "file") {
// // // //         tempMessage.file = {
// // // //           name: file.name,
// // // //           url: reader.result,
// // // //         };
// // // //       }

// // // //       setMessages((prev) => {
// // // //         const newMessages = [...prev, tempMessage];
// // // //         console.log("Tin nh·∫Øn ƒë√£ c·∫≠p nh·∫≠t:", newMessages);
// // // //         return newMessages;
// // // //       });

// // // //       // UPLOAD SAU - Async
// // // //       uploadFileToServer(file, mediaType, tempMessage.id);
// // // //     };

// // // //     reader.onerror = () => {
// // // //       alert("L·ªói khi ƒë·ªçc t·ªáp.");
// // // //       console.error("FileReader l·ªói:", reader.error);
// // // //     };
// // // //     reader.readAsDataURL(file);
// // // //   };

// // // //   // H√†m upload file l√™n server
// // // //   const uploadFileToServer = async (file, mediaType, messageId) => {
// // // //     const formData = new FormData();
// // // //     let endpoint;

// // // //     // Th√™m file v√†o FormData v·ªõi t√™n g·ªëc ƒë·ªÉ h·ªó tr·ª£ ti·∫øng Vi·ªát
// // // //     if (mediaType === "image") {
// // // //       formData.append("file", file, encodeURIComponent(file.name));
// // // //       endpoint = "/upload-file";
// // // //     } else if (mediaType === "video") {
// // // //       formData.append("video", file, encodeURIComponent(file.name));
// // // //       endpoint = "/upload-video";
// // // //     } else if (mediaType === "file") {
// // // //       formData.append("file", file, encodeURIComponent(file.name));
// // // //       endpoint = "/upload-file";
// // // //     }

// // // //     try {
// // // //       console.log("‚è≥ B·∫Øt ƒë·∫ßu upload t·ªáp:", file.name);
// // // //       const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
// // // //         headers: {
// // // //           "Content-Type": "multipart/form-data",
// // // //           "Accept": "application/json",
// // // //         },
// // // //       });

// // // //       if (uploadResponse.data.url) {
// // // //         const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");

// // // //         // C·∫≠p nh·∫≠t message v·ªõi URL th·∫≠t t·ª´ server
// // // //         setMessages((prev) =>
// // // //           prev.map((msg) => {
// // // //             if (msg.id === messageId) {
// // // //               const updatedMsg = { ...msg, uploading: false };

// // // //               if (mediaType === "image") {
// // // //                 updatedMsg.image = uploadResponse.data.url;
// // // //                 updatedMsg.fileName = decodeURIComponent(file.name);
// // // //               } else if (mediaType === "video") {
// // // //                 updatedMsg.video = uploadResponse.data.url;
// // // //                 updatedMsg.fileName = decodeURIComponent(file.name);
// // // //               } else if (mediaType === "file") {
// // // //                 updatedMsg.file = {
// // // //                   name: decodeURIComponent(file.name),
// // // //                   url: uploadResponse.data.url,
// // // //                 };
// // // //               }

// // // //               return updatedMsg;
// // // //             }
// // // //             return msg;
// // // //           })
// // // //         );

// // // //         console.log("Upload th√†nh c√¥ng, URL:", uploadResponse.data.url);

// // // //         // G·ª≠i message qua WebSocket
// // // //         if (socketRef.current) {
// // // //         socketRef.current.emit("sendMessage", {
// // // //           toUserId: friend.member,
// // // //           message: {
// // // //             id: "",
// // // //             conversation_id: friend.id,
// // // //             sender: friend.sender,
// // // //             recipient: friend.member,
// // // //             content: file.name,
// // // //             message_type: mediaType,
// // // //             timestamp: new Date().toISOString(),
// // // //             url: filePath,
// // // //           },
// // // //         });

// // // //         console.log("üì§ G·ª≠i ƒë·∫øn", friend.member);
// // // //         console.log("D·ªØ li·ªáu g·ª≠i l√™n server:", {
// // // //           id: "",
// // // //           conversationId: friend.id,
// // // //           sender: friend.sender,
// // // //           content: decodeURIComponent(file.name),
// // // //           message_type: mediaType,
// // // //           timestamp: new Date().toISOString(),
// // // //           recipient: friend.member,
// // // //           url: filePath,
// // // //         });
// // // //       }


// // // //         // API 2: G·ª≠i message l√™n server
// // // //         try {
// // // //           const messageResponse = await axios.post("http://localhost:5000/api/chat/send-message/", {
// // // //             id: "",
// // // //             conversationId: friend.id,
// // // //             sender: friend.sender,
// // // //             content: decodeURIComponent(file.name),
// // // //             message_type: mediaType,
// // // //             timestamp: new Date().toISOString(),
// // // //             recipient: friend.member,
// // // //             url: filePath,
// // // //           });
// // // //           console.log("Tin nh·∫Øn ƒë√£ l∆∞u server:", messageResponse.data);
// // // //         } catch (messageError) {
// // // //           console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
// // // //         }
// // // //       }
// // // //     } catch (uploadError) {
// // // //       console.error("L·ªói upload:", uploadError);

// // // //       setMessages((prev) =>
// // // //         prev.map((msg) => {
// // // //           if (msg.id === messageId) {
// // // //             return {
// // // //               ...msg,
// // // //               uploading: false,
// // // //               error: true,
// // // //             };
// // // //           }
// // // //           return msg;
// // // //         })
// // // //       );

// // // //       alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
// // // //     }
// // // //   };

// // // //   const handleSendFriendRequest = (friendId, friendName) => {
// // // //     console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
// // // //   };

// // // //   const handleConfirmFriendRequest = (friendId, friendName) => {
// // // //     console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // // //   };

// // // //   const handleRejectFriendRequest = (friendId, friendName) => {
// // // //     console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // // //   };

// // // //   const handleClosePreview = () => {
// // // //     setPreviewImage(null);
// // // //   };

// // // //   const isValidUrl = (url) => {
// // // //     try {
// // // //       new URL(url);
// // // //       return true;
// // // //     } catch {
// // // //       return false;
// // // //     }
// // // //   };

// // // //   const renderMessageContent = (message) => {

// // // //     console.log("Render n·ªôi dung tin nh·∫Øn:", message);
    
// // // //     if (message.image) {
// // // //       return (
// // // //         <div className={cx("message-image")} onClick={() => setPreviewImage(message.image)} aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh">
// // // //           <img src={message.image} alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"} style={{ maxWidth: "100%", borderRadius: "8px" }} />
// // // //         </div>
// // // //       );
// // // //     }
// // // //     if (message.video) {
// // // //       return (
// // // //         <div className={cx("message-video")}>
// // // //           <video controls style={{ maxWidth: "100%", borderRadius: "8px" }}>
// // // //             <source src={message.video} type="video/mp4" />
// // // //             Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
// // // //           </video>
// // // //         </div>
// // // //       );
// // // //     }
// // // //     if (message.file) {
// // // //       return (
// // // //         <div className={cx("message-file")}>
// // // //           <a href={message.file.url} download={message.file.name}>
// // // //             {message.file.name}
// // // //           </a>
// // // //         </div>
// // // //       );
// // // //     }
// // // //     if (typeof message.text === "string" && message.text) {
// // // //       const urlRegex = /(https?:\/\/[^\s]+)/g;
// // // //       const parts = message.text.split(urlRegex);
// // // //       return (
// // // //         <span>
// // // //           {parts.map((part, index) => {
// // // //             if (part.match(urlRegex) && isValidUrl(part)) {
// // // //               return (
// // // //                 <a
// // // //                   key={index}
// // // //                   href={part}
// // // //                   target="_blank"
// // // //                   rel="noopener noreferrer"
// // // //                   style={{ color: "blue", textDecoration: "underline" }}
// // // //                 >
// // // //                   {part}
// // // //                 </a>
// // // //               );
// // // //             }
// // // //             return part;
// // // //           })}
// // // //         </span>
// // // //       );
// // // //     }
// // // //     return <span>{message.text || ""}</span>;
// // // //   };

// // // //   const formatTime = (dateObj) => {
// // // //     return dateObj.toLocaleTimeString("vi-VN", {
// // // //       hour: "2-digit",
// // // //       minute: "2-digit",
// // // //       hour12: true,
// // // //     });
// // // //   };

// // // //   const formatSeparator = (dateObj) => {
// // // //     return (
// // // //       dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
// // // //       " " +
// // // //       formatTime(dateObj)
// // // //     );
// // // //   };

// // // //   if (!friend) {
// // // //     return (
// // // //       <div className={cx("chat")}>
// // // //         <div className={cx("empty-state")}>
// // // //           <div className={cx("empty-content")}>
// // // //             <div className={cx("empty-icon")}>
// // // //               <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
// // // //                 <path
// // // //                   d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
// // // //                   fill="currentColor"
// // // //                   opacity="0.3"
// // // //                 />
// // // //                 <circle cx="8" cy="12" r="1" fill="currentColor" />
// // // //                 <circle cx="12" cy="12" r="1" fill="currentColor" />
// // // //                 <circle cx="16" cy="12" r="1" fill="currentColor" />
// // // //               </svg>
// // // //             </div>
// // // //             <div className={cx("empty-text")}>
// // // //               <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
// // // //               <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
// // // //             </div>
// // // //           </div>
// // // //         </div>
// // // //       </div>
// // // //     );
// // // //   }

// // // //   return (
// // // //     <div className={cx("chat")}>
// // // //       <ChatHeader 
// // // //         friend={friend} 
// // // //         onAvatarClick={handleAvatarClick}
// // // //         onToggleDetail={onToggleDetail}
// // // //       />

// // // //       {showSendRequestBar ? (
// // // //         <FriendRequestBar
// // // //           friend={friend}
// // // //           onSendRequest={handleSendFriendRequest}
// // // //           isVisible={false}
// // // //         />
// // // //       ) : (
// // // //         <FriendRequestConfirmationBar
// // // //           friend={friend}
// // // //           onConfirmRequest={handleConfirmFriendRequest}
// // // //           onRejectRequest={handleRejectFriendRequest}
// // // //           isVisible={false}
// // // //         />
// // // //       )}

// // // //       <div className={cx("center")} ref={messagesContainerRef}>
// // // //         {loading ? (
// // // //           <div>ƒêang t·∫£i...</div>
// // // //         ) : error ? (
// // // //           <div className={cx("error")}>{error}</div>
// // // //         ) : (
// // // //           messages.map((message, index) => {
// // // //             const prevMsg = messages[index - 1];
// // // //             const nextMsg = messages[index + 1];
// // // //             const currentTime = message.timestamp;

// // // //             let showSeparator = false;
// // // //             let showTime = false;

// // // //             if (!prevMsg) {
// // // //               showSeparator = true;
// // // //             } else {
// // // //               const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
// // // //               if (diffMinutes >= 10) {
// // // //                 showSeparator = true;
// // // //               }
// // // //             }

// // // //             if (!nextMsg) {
// // // //               showTime = true;
// // // //             } else {
// // // //               const sameMinute =
// // // //                 currentTime.getHours() === nextMsg.timestamp.getHours() &&
// // // //                 currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
// // // //               if (!sameMinute) {
// // // //                 showTime = true;
// // // //               }
// // // //             }

// // // //             return (
// // // //               <div key={message.id}>
// // // //                 {showSeparator && (
// // // //                   <div className={cx("time-separator")}>
// // // //                     <div className={cx("time-separator-content")}>
// // // //                       {formatSeparator(message.timestamp)}
// // // //                     </div>
// // // //                   </div>
// // // //                 )}
// // // //                 <div className={cx("message", message.type)}>
// // // //                   <div
// // // //                     className={cx("message-bubble", {
// // // //                       "has-media": message.image || message.video || message.file,
// // // //                     })}
// // // //                   >
// // // //                     {renderMessageContent(message)}
// // // //                     {message.text && (message.image || message.video || message.file) && (
// // // //                       <div className={cx("message-text")}>{message.text}</div>
// // // //                     )}
// // // //                   </div>
// // // //                   {showTime && (
// // // //                     <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
// // // //                   )}
// // // //                 </div>
// // // //               </div>
// // // //             );
// // // //           })
// // // //         )}
// // // //       </div>

// // // //       {previewImage && (
// // // //         <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />
// // // //       )}

// // // //       <div className={cx("cr")}>
// // // //         <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
// // // //           <input
// // // //             type="file"
// // // //             accept="image/*"
// // // //             style={{ display: "none" }}
// // // //             onChange={(e) => handleMediaSelect(e, "image")}
// // // //           />
// // // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // // //             <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
// // // //           </svg>
// // // //         </label>
// // // //         <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
// // // //           <input
// // // //             type="file"
// // // //             accept=".pdf,.doc,.docx,.txt"
// // // //             style={{ display: "none" }}
// // // //             onChange={(e) => handleMediaSelect(e, "file")}
// // // //           />
// // // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // // //             <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
// // // //           </svg>
// // // //         </label>
// // // //         <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
// // // //           <input
// // // //             type="file"
// // // //             accept="video/*"
// // // //             style={{ display: "none" }}
// // // //             onChange={(e) => handleMediaSelect(e, "video")}
// // // //           />
// // // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // // //             <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
// // // //           </svg>
// // // //         </label>
// // // //       </div>

// // // //       <div className={cx("input-area")}>
// // // //         <input
// // // //           type="text"
// // // //           placeholder="Nh·∫≠p tin nh·∫Øn..."
// // // //           value={text}
// // // //           onChange={(e) => setText(e.target.value)}
// // // //           onKeyPress={handleKeyPress}
// // // //           className={cx("message-input")}
// // // //           aria-label="Nh·∫≠p tin nh·∫Øn"
// // // //         />
// // // //         <div className={cx("emoji-container")}>
// // // //           <button 
// // // //             className={cx("emoji-button")} 
// // // //             onClick={() => setOpen((prev) => !prev)}
// // // //             aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
// // // //           >
// // // //             üòä
// // // //           </button>
// // // //           <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
// // // //             {emojis.map((emoji, index) => (
// // // //               <button
// // // //                 key={index}
// // // //                 onClick={() => handleEmoji(emoji)}
// // // //                 className={cx("emoji-item")}
// // // //                 aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
// // // //               >
// // // //                 {emoji}
// // // //               </button>
// // // //             ))}
// // // //           </div>
// // // //         </div>
// // // //         <button 
// // // //           onClick={handleSend} 
// // // //           className={cx("send-button", { active: text.trim() })}
// // // //           aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
// // // //         >
// // // //           {text.trim() ? (
// // // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // // //               <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
// // // //             </svg>
// // // //           ) : (
// // // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // // //               <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
// // // //             </svg>
// // // //           )}
// // // //         </button>
// // // //       </div>

// // // //       {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
// // // //       {showProfile && 
// // // //         <ProFile1 
// // // //           onClose={() => setShowProFile(false)} 
// // // //           datax={friend}
// // // //         />}
// // // //     </div>
// // // //   );
// // // // }

// // // // export default Chat;


// // // import classNames from "classnames/bind";
// // // import styles from "./Chat.module.scss";
// // // import { useState, useEffect, useRef } from "react";
// // // import ProFile1 from "~/pages/ProFile1";
// // // import ChatPreview from "./ChatPreview";
// // // import FriendRequestBar from "./FriendRequestBar";
// // // import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
// // // import ChatHeader from "./ChatHeader";
// // // import axios from "axios";
// // // import { io } from "socket.io-client";

// // // const cx = classNames.bind(styles);

// // // function Chat({ friend, onToggleDetail }) {
// // //   const [open, setOpen] = useState(false);
// // //   const [text, setText] = useState("");
// // //   const [showProfile, setShowProFile] = useState(false);
// // //   const [previewImage, setPreviewImage] = useState(null);
// // //   const messagesContainerRef = useRef(null);
// // //   const [messages, setMessages] = useState([]);
// // //   const [loading, setLoading] = useState(true);
// // //   const [error, setError] = useState(null);
// // //   const [showSendRequestBar, setShowSendRequestBar] = useState(false);
// // //   const socketRef = useRef(null);

// // //   // H√†m cu·ªôn xu·ªëng cu·ªëi
// // //   const scrollToBottom = () => {
// // //     if (messagesContainerRef.current) {
// // //       messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
// // //     }
// // //   };

// // //   // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
// // //   useEffect(() => {
// // //     scrollToBottom();
// // //   }, [messages]);

// // //   // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
// // //   useEffect(() => {
// // //     if (friend?.sender) {
// // //       socketRef.current = io("http://localhost:5000", {
// // //         query: { userId: friend.sender },
// // //       });

// // //       socketRef.current.on("receiveMessage", (data) => {
// // //         console.log("üì© Nh·∫≠n t·ª´", data.from, ":", data.message);

// // //         const receivedMessage = {
// // //           id: new Date() + Math.random(),
// // //           text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
// // //           type: data.message.sender !== friend.member ? "sent" : "received",
// // //           timestamp: new Date(data.message.timestamp),
// // //           // X·ª≠ l√Ω media real-time v·ªõi base64 n·∫øu c√≥
// // //           image: data.message.message_type === "image" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
// // //           video: data.message.message_type === "video" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
// // //           file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
// // //           // Flag ƒë·ªÉ bi·∫øt ƒë√¢y l√† base64 t·∫°m th·ªùi hay URL final
// // //           isTemporary: !!data.message.base64Data,
// // //         };

// // //         setMessages((prev) => [...prev, receivedMessage]);

// // //         console.log("Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω:", receivedMessage);
// // //       });

// // //       return () => {
// // //         if (socketRef.current) {
// // //           socketRef.current.disconnect();
// // //         }
// // //       };
// // //     }
// // //   }, [friend?.sender]);

// // //   // Fetch tin nh·∫Øn t·ª´ API
// // //   useEffect(() => {
// // //     console.log("useEffect fetchMessages ch·∫°y l·∫°i");
// // //     const fetchMessages = async () => {
// // //       if (!friend || !friend.id) {
// // //         setMessages([]);
// // //         setLoading(false);
// // //         return;
// // //       }

// // //       try {
// // //         const response = await axios.post("http://localhost:5000/api/chat/messages/", {
// // //           friendId: friend.id,
// // //         });

// // //         if (response.status === 200 && Array.isArray(response.data)) {
// // //           // Transform d·ªØ li·ªáu ƒë·ªÉ kh·ªõp c·∫•u tr√∫c component
// // //           const transformedMessages = response.data
// // //             .map((msg) => ({
// // //               id: msg.id,
// // //               text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
// // //               type: msg.sender !== friend.member ? "sent" : "received",
// // //               timestamp: new Date(msg.timestamp),
// // //               image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
// // //               video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
// // //               file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
// // //               isTemporary: false, // Tin nh·∫Øn t·ª´ database kh√¥ng ph·∫£i t·∫°m th·ªùi
// // //             }))
// // //             .filter((msg) => msg.text || msg.image || msg.video || msg.file);

// // //           console.log("Tin nh·∫Øn ƒë√£ chuy·ªÉn ƒë·ªïi:", transformedMessages);
// // //           setMessages(transformedMessages);
// // //         } else {
// // //           setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
// // //         }
// // //       } catch (err) {
// // //         setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
// // //         console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
// // //       } finally {
// // //         setLoading(false);
// // //       }
// // //     };

// // //     fetchMessages();
// // //   }, [friend]);

// // //   // H√†m toggle gi·ªØa RequestBar v√† ConfirmBar
// // //   const toggleRequestBar = () => {
// // //     setShowSendRequestBar((prev) => !prev);
// // //   };

// // //   const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

// // //   const handleEmoji = (emoji) => {
// // //     setText((prev) => prev + emoji);
// // //     setOpen(false);
// // //   };

// // //   const handleSend = async () => {
// // //     if (text.trim()) {
// // //       const newMessage = {
// // //         id: Date.now(),
// // //         text: text.trim(),
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         isTemporary: false,
// // //       };
// // //       setMessages((prev) => [...prev, newMessage]);
// // //       setText("");

// // //       if (socketRef.current) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: "",
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: newMessage.text,
// // //             message_type: "text",
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //           },
// // //         });
// // //         console.log("üì§ G·ª≠i ƒë·∫øn", friend.member, ":", newMessage.text);
// // //       }

// // //       try {
// // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //           id: "",
// // //           conversationId: friend.id,
// // //           sender: friend.sender,
// // //           content: text.trim(),
// // //           message_type: "text",
// // //           timestamp: new Date().toISOString(),
// // //           recipient: friend.member,
// // //         });
// // //       } catch (error) {
// // //         console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
// // //       }
// // //     } else {
// // //       const likeMessage = {
// // //         id: Date.now(),
// // //         text: "üëç",
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         isTemporary: false,
// // //       };
// // //       setMessages((prev) => [...prev, likeMessage]);

// // //       if (socketRef.current) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: "",
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: "üëç",
// // //             message_type: "text",
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //           },
// // //         });
// // //         console.log("üì§ G·ª≠i ƒë·∫øn", friend.member, ": üëç");
// // //       }

// // //       try {
// // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //           id: "",
// // //           conversationId: friend.id,
// // //           sender: friend.sender,
// // //           content: "üëç",
// // //           message_type: "text",
// // //           timestamp: new Date().toISOString(),
// // //           recipient: friend.member,
// // //         });
// // //       } catch (error) {
// // //         console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
// // //       }
// // //     }
// // //   };

// // //   const handleKeyPress = (e) => {
// // //     if (e.key === "Enter") {
// // //       handleSend();
// // //     }
// // //   };

// // //   const handleAvatarClick = () => {
// // //     setShowProFile(true);
// // //   };

// // //   // H√†m x·ª≠ l√Ω ch·ªçn file media v·ªõi real-time base64 rendering
// // //   const handleMediaSelect = async (e, mediaType) => {
// // //     const file = e.target.files[0];
// // //     if (!file) {
// // //       alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
// // //       console.log("Kh√¥ng c√≥ t·ªáp ƒë∆∞·ª£c ch·ªçn.");
// // //       return;
// // //     }

// // //     if (file.size > 50 * 1024 * 1024) {
// // //       alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
// // //       console.log("T·ªáp qu√° l·ªõn:", file.size);
// // //       return;
// // //     }

// // //     if (mediaType === "image" && !file.type.startsWith("image/")) {
// // //       alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
// // //       console.log("T·ªáp kh√¥ng ph·∫£i h√¨nh ·∫£nh:", file.type);
// // //       return;
// // //     }

// // //     if (mediaType === "video" && !file.type.startsWith("video/")) {
// // //       alert("Vui l√≤ng ch·ªçn t·ªáp video.");
// // //       console.log("T·ªáp kh√¥ng ph·∫£i video:", file.type);
// // //       return;
// // //     }

// // //     // HI·ªÇN TH·ªä TR∆Ø·ªöC v·ªõi base64 (Real-time)
// // //     const reader = new FileReader();
// // //     reader.onload = () => {
// // //       console.log("FileReader onload, preview URL:", reader.result.substring(0, 50) + "...");

// // //       const tempMessageId = Date.now() + Math.random();
// // //       const tempMessage = {
// // //         id: tempMessageId,
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         uploading: true,
// // //         fileName: file.name,
// // //         isTemporary: true, // ƒê√°nh d·∫•u l√† temporary message
// // //       };

// // //       // Render ·∫£nh/video ngay v·ªõi base64 cho real-time experience
// // //       if (mediaType === "image") {
// // //         tempMessage.image = reader.result; // base64 URL
// // //       } else if (mediaType === "video") {
// // //         tempMessage.video = reader.result; // base64 URL
// // //       } else if (mediaType === "file") {
// // //         tempMessage.file = {
// // //           name: file.name,
// // //           url: reader.result, // base64 URL
// // //         };
// // //       }

// // //       // Th√™m v√†o messages ngay l·∫≠p t·ª©c
// // //       setMessages((prev) => {
// // //         const newMessages = [...prev, tempMessage];
// // //         console.log("Tin nh·∫Øn t·∫°m th·ªùi ƒë√£ th√™m:", tempMessage);
// // //         return newMessages;
// // //       });

// // //       // G·ª≠i base64 qua WebSocket cho real-time (ch·ªâ ·∫£nh v√† video)
// // //       if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: tempMessageId,
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: file.name,
// // //             message_type: mediaType,
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //             base64Data: reader.result, // G·ª≠i base64 cho real-time
// // //           },
// // //         });
// // //         console.log(`üì§ G·ª≠i ${mediaType} base64 real-time ƒë·∫øn ${friend.member}`);
// // //       }

// // //       // UPLOAD file l√™n server (background)
// // //       uploadFileToServer(file, mediaType, tempMessageId);
// // //     };

// // //     reader.onerror = () => {
// // //       alert("L·ªói khi ƒë·ªçc t·ªáp.");
// // //       console.error("FileReader l·ªói:", reader.error);
// // //     };
// // //     reader.readAsDataURL(file);
// // //   };

// // //   // H√†m upload file l√™n server
// // //   const uploadFileToServer = async (file, mediaType, messageId) => {
// // //     const formData = new FormData();
// // //     let endpoint;

// // //     // Th√™m file v√†o FormData v·ªõi t√™n g·ªëc ƒë·ªÉ h·ªó tr·ª£ ti·∫øng Vi·ªát
// // //     if (mediaType === "image") {
// // //       formData.append("file", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-file";
// // //     } else if (mediaType === "video") {
// // //       formData.append("video", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-video";
// // //     } else if (mediaType === "file") {
// // //       formData.append("file", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-file";
// // //     }

// // //     try {
// // //       console.log("‚è≥ B·∫Øt ƒë·∫ßu upload t·ªáp:", file.name);
// // //       const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
// // //         headers: {
// // //           "Content-Type": "multipart/form-data",
// // //           "Accept": "application/json",
// // //         },
// // //       });

// // //       if (uploadResponse.data.url) {
// // //         const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");
// // //         const fullUrl = uploadResponse.data.url;

// // //         // C·∫≠p nh·∫≠t message v·ªõi URL th·∫≠t t·ª´ server
// // //         setMessages((prev) =>
// // //           prev.map((msg) => {
// // //             if (msg.id === messageId) {
// // //               const updatedMsg = { 
// // //                 ...msg, 
// // //                 uploading: false,
// // //                 isTemporary: false, // Kh√¥ng c√≤n t·∫°m th·ªùi n·ªØa
// // //               };

// // //               if (mediaType === "image") {
// // //                 updatedMsg.image = fullUrl; // Thay th·∫ø base64 b·∫±ng URL server
// // //                 updatedMsg.fileName = decodeURIComponent(file.name);
// // //               } else if (mediaType === "video") {
// // //                 updatedMsg.video = fullUrl; // Thay th·∫ø base64 b·∫±ng URL server
// // //                 updatedMsg.fileName = decodeURIComponent(file.name);
// // //               } else if (mediaType === "file") {
// // //                 updatedMsg.file = {
// // //                   name: decodeURIComponent(file.name),
// // //                   url: fullUrl,
// // //                 };
// // //               }

// // //               return updatedMsg;
// // //             }
// // //             return msg;
// // //           })
// // //         );

// // //         console.log("Upload th√†nh c√¥ng, URL:", uploadResponse.data.url);

// // //         // G·ª≠i message v·ªõi URL final qua WebSocket
// // //         if (socketRef.current) {
// // //           socketRef.current.emit("sendMessage", {
// // //             toUserId: friend.member,
// // //             message: {
// // //               id: "",
// // //               conversation_id: friend.id,
// // //               sender: friend.sender,
// // //               recipient: friend.member,
// // //               content: file.name,
// // //               message_type: mediaType,
// // //               timestamp: new Date().toISOString(),
// // //               url: filePath,
// // //               // Kh√¥ng g·ª≠i base64Data n·ªØa v√¨ ƒë√£ c√≥ URL
// // //             },
// // //           });
// // //           console.log(`üì§ G·ª≠i ${mediaType} URL final ƒë·∫øn ${friend.member}`);
// // //         }

// // //         // API: L∆∞u message v√†o server
// // //         try {
// // //           const messageResponse = await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //             id: "",
// // //             conversationId: friend.id,
// // //             sender: friend.sender,
// // //             content: decodeURIComponent(file.name),
// // //             message_type: mediaType,
// // //             timestamp: new Date().toISOString(),
// // //             recipient: friend.member,
// // //             url: filePath,
// // //           });
// // //           console.log("Tin nh·∫Øn ƒë√£ l∆∞u server:", messageResponse.data);
// // //         } catch (messageError) {
// // //           console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
// // //         }
// // //       }
// // //     } catch (uploadError) {
// // //       console.error("L·ªói upload:", uploadError);

// // //       setMessages((prev) =>
// // //         prev.map((msg) => {
// // //           if (msg.id === messageId) {
// // //             return {
// // //               ...msg,
// // //               uploading: false,
// // //               error: true,
// // //               isTemporary: false,
// // //             };
// // //           }
// // //           return msg;
// // //         })
// // //       );

// // //       alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
// // //     }
// // //   };

// // //   const handleSendFriendRequest = (friendId, friendName) => {
// // //     console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
// // //   };

// // //   const handleConfirmFriendRequest = (friendId, friendName) => {
// // //     console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // //   };

// // //   const handleRejectFriendRequest = (friendId, friendName) => {
// // //     console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // //   };

// // //   const handleClosePreview = () => {
// // //     setPreviewImage(null);
// // //   };

// // //   const isValidUrl = (url) => {
// // //     try {
// // //       new URL(url);
// // //       return true;
// // //     } catch {
// // //       return false;
// // //     }
// // //   };

// // //   const renderMessageContent = (message) => {
// // //     console.log("Render n·ªôi dung tin nh·∫Øn:", message);
    
// // //     // Hi·ªÉn th·ªã tr·∫°ng th√°i uploading
// // //     if (message.uploading) {
// // //       return (
// // //         <div className={cx("message-uploading")}>
// // //           <span>ƒêang t·∫£i {message.fileName}...</span>
// // //         </div>
// // //       );
// // //     }

// // //     // Hi·ªÉn th·ªã l·ªói
// // //     if (message.error) {
// // //       return (
// // //         <div className={cx("message-error")}>
// // //           <span>L·ªói t·∫£i {message.fileName}</span>
// // //         </div>
// // //       );
// // //     }
    
// // //     if (message.image) {
// // //       return (
// // //         <div 
// // //           className={cx("message-image", { "temporary": message.isTemporary })} 
// // //           onClick={() => setPreviewImage(message.image)} 
// // //           aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
// // //         >
// // //           <img 
// // //             src={message.image} 
// // //             alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"} 
// // //             style={{ 
// // //               maxWidth: "100%", 
// // //               borderRadius: "8px",
// // //               opacity: message.isTemporary ? 0.8 : 1, // L√†m m·ªù m·ªôt ch√∫t cho base64
// // //             }} 
// // //           />
// // //           {message.isTemporary && (
// // //             <div className={cx("temporary-indicator")}>
// // //               <span>ƒêang x·ª≠ l√Ω...</span>
// // //             </div>
// // //           )}
// // //         </div>
// // //       );
// // //     }
    
// // //     if (message.video) {
// // //       return (
// // //         <div className={cx("message-video", { "temporary": message.isTemporary })}>
// // //           <video 
// // //             controls 
// // //             style={{ 
// // //               maxWidth: "100%", 
// // //               borderRadius: "8px",
// // //               opacity: message.isTemporary ? 0.8 : 1, // L√†m m·ªù m·ªôt ch√∫t cho base64
// // //             }}
// // //           >
// // //             <source src={message.video} type="video/mp4" />
// // //             Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
// // //           </video>
// // //           {message.isTemporary && (
// // //             <div className={cx("temporary-indicator")}>
// // //               <span>ƒêang x·ª≠ l√Ω...</span>
// // //             </div>
// // //           )}
// // //         </div>
// // //       );
// // //     }
    
// // //     if (message.file) {
// // //       return (
// // //         <div className={cx("message-file")}>
// // //           <a href={message.file.url} download={message.file.name}>
// // //             {message.file.name}
// // //           </a>
// // //         </div>
// // //       );
// // //     }
    
// // //     if (typeof message.text === "string" && message.text) {
// // //       const urlRegex = /(https?:\/\/[^\s]+)/g;
// // //       const parts = message.text.split(urlRegex);
// // //       return (
// // //         <span>
// // //           {parts.map((part, index) => {
// // //             if (part.match(urlRegex) && isValidUrl(part)) {
// // //               return (
// // //                 <a
// // //                   key={index}
// // //                   href={part}
// // //                   target="_blank"
// // //                   rel="noopener noreferrer"
// // //                   style={{ color: "blue", textDecoration: "underline" }}
// // //                 >
// // //                   {part}
// // //                 </a>
// // //               );
// // //             }
// // //             return part;
// // //           })}
// // //         </span>
// // //       );
// // //     }
// // //     return <span>{message.text || ""}</span>;
// // //   };

// // //   const formatTime = (dateObj) => {
// // //     return dateObj.toLocaleTimeString("vi-VN", {
// // //       hour: "2-digit",
// // //       minute: "2-digit",
// // //       hour12: true,
// // //     });
// // //   };

// // //   const formatSeparator = (dateObj) => {
// // //     return (
// // //       dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
// // //       " " +
// // //       formatTime(dateObj)
// // //     );
// // //   };

// // //   if (!friend) {
// // //     return (
// // //       <div className={cx("chat")}>
// // //         <div className={cx("empty-state")}>
// // //           <div className={cx("empty-content")}>
// // //             <div className={cx("empty-icon")}>
// // //               <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
// // //                 <path
// // //                   d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
// // //                   fill="currentColor"
// // //                   opacity="0.3"
// // //                 />
// // //                 <circle cx="8" cy="12" r="1" fill="currentColor" />
// // //                 <circle cx="12" cy="12" r="1" fill="currentColor" />
// // //                 <circle cx="16" cy="12" r="1" fill="currentColor" />
// // //               </svg>
// // //             </div>
// // //             <div className={cx("empty-text")}>
// // //               <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
// // //               <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   }

// // //   return (
// // //     <div className={cx("chat")}>
// // //       <ChatHeader 
// // //         friend={friend} 
// // //         onAvatarClick={handleAvatarClick}
// // //         onToggleDetail={onToggleDetail}
// // //       />

// // //       {showSendRequestBar ? (
// // //         <FriendRequestBar
// // //           friend={friend}
// // //           onSendRequest={handleSendFriendRequest}
// // //           isVisible={false}
// // //         />
// // //       ) : (
// // //         <FriendRequestConfirmationBar
// // //           friend={friend}
// // //           onConfirmRequest={handleConfirmFriendRequest}
// // //           onRejectRequest={handleRejectFriendRequest}
// // //           isVisible={false}
// // //         />
// // //       )}

// // //       <div className={cx("center")} ref={messagesContainerRef}>
// // //         {loading ? (
// // //           <div>ƒêang t·∫£i...</div>
// // //         ) : error ? (
// // //           <div className={cx("error")}>{error}</div>
// // //         ) : (
// // //           messages.map((message, index) => {
// // //             const prevMsg = messages[index - 1];
// // //             const nextMsg = messages[index + 1];
// // //             const currentTime = message.timestamp;

// // //             let showSeparator = false;
// // //             let showTime = false;

// // //             if (!prevMsg) {
// // //               showSeparator = true;
// // //             } else {
// // //               const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
// // //               if (diffMinutes >= 10) {
// // //                 showSeparator = true;
// // //               }
// // //             }

// // //             if (!nextMsg) {
// // //               showTime = true;
// // //             } else {
// // //               const sameMinute =
// // //                 currentTime.getHours() === nextMsg.timestamp.getHours() &&
// // //                 currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
// // //               if (!sameMinute) {
// // //                 showTime = true;
// // //               }
// // //             }

// // //             return (
// // //               <div key={message.id}>
// // //                 {showSeparator && (
// // //                   <div className={cx("time-separator")}>
// // //                     <div className={cx("time-separator-content")}>
// // //                       {formatSeparator(message.timestamp)}
// // //                     </div>
// // //                   </div>
// // //                 )}
// // //                 <div className={cx("message", message.type)}>
// // //                   <div
// // //                     className={cx("message-bubble", {
// // //                       "has-media": message.image || message.video || message.file,
// // //                       "temporary": message.isTemporary,
// // //                     })}
// // //                   >
// // //                     {renderMessageContent(message)}
// // //                     {message.text && (message.image || message.video || message.file) && (
// // //                       <div className={cx("message-text")}>{message.text}</div>
// // //                     )}
// // //                   </div>
// // //                   {showTime && (
// // //                     <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
// // //                   )}
// // //                 </div>
// // //               </div>
// // //             );
// // //           })
// // //         )}
// // //       </div>

// // //       {previewImage && (
// // //         <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />
// // //       )}

// // //       <div className={cx("cr")}>
// // //         <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept="image/*"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "image")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
// // //           </svg>
// // //         </label>
// // //         <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept=".pdf,.doc,.docx,.txt"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "file")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
// // //           </svg>
// // //         </label>
// // //         <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept="video/*"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "video")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
// // //           </svg>
// // //         </label>
// // //       </div>

// // //       <div className={cx("input-area")}>
// // //         <input
// // //           type="text"
// // //           placeholder="Nh·∫≠p tin nh·∫Øn..."
// // //           value={text}
// // //           onChange={(e) => setText(e.target.value)}
// // //           onKeyPress={handleKeyPress}
// // //           className={cx("message-input")}
// // //           aria-label="Nh·∫≠p tin nh·∫Øn"
// // //         />
// // //         <div className={cx("emoji-container")}>
// // //           <button 
// // //             className={cx("emoji-button")} 
// // //             onClick={() => setOpen((prev) => !prev)}
// // //             aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
// // //           >
// // //             üòä
// // //           </button>
// // //           <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
// // //             {emojis.map((emoji, index) => (
// // //               <button
// // //                 key={index}
// // //                 onClick={() => handleEmoji(emoji)}
// // //                 className={cx("emoji-item")}
// // //                 aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
// // //               >
// // //                 {emoji}
// // //               </button>
// // //             ))}
// // //           </div>
// // //         </div>
// // //         <button 
// // //           onClick={handleSend} 
// // //           className={cx("send-button", { active: text.trim() })}
// // //           aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
// // //         >
// // //           {text.trim() ? (
// // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //               <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
// // //             </svg>
// // //           ) : (
// // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //               <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
// // //             </svg>
// // //           )}
// // //         </button>
// // //       </div>

// // //       {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
// // //       {showProfile && 
// // //         <ProFile1 
// // //           onClose={() => setShowProFile(false)} 
// // //           datax={friend}
// // //         />}
// // //     </div>
// // //   );
// // // }

// // // export default Chat;


// // // import classNames from "classnames/bind";
// // // import styles from "./Chat.module.scss";
// // // import { useState, useEffect, useRef, useCallback } from "react";
// // // import ProFile1 from "~/pages/ProFile1";
// // // import ChatPreview from "./ChatPreview";
// // // import FriendRequestBar from "./FriendRequestBar";
// // // import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
// // // import ChatHeader from "./ChatHeader";
// // // import axios from "axios";
// // // import { io } from "socket.io-client";

// // // const cx = classNames.bind(styles);

// // // function Chat({ friend, onToggleDetail }) {
// // //   const [open, setOpen] = useState(false);
// // //   const [text, setText] = useState("");
// // //   const [showProfile, setShowProFile] = useState(false);
// // //   const [previewImage, setPreviewImage] = useState(null);
// // //   const messagesContainerRef = useRef(null);
// // //   const [messages, setMessages] = useState([]);
// // //   const [loading, setLoading] = useState(true);
// // //   const [error, setError] = useState(null);
// // //   const [showSendRequestBar, setShowSendRequestBar] = useState(false);
// // //   const socketRef = useRef(null);

// // //   // H√†m cu·ªôn xu·ªëng cu·ªëi
// // //   const scrollToBottom = useCallback(() => {
// // //     if (messagesContainerRef.current) {
// // //       messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
// // //     }
// // //   }, []);

// // //   // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
// // //   useEffect(() => {
// // //     scrollToBottom();
// // //   }, [messages, scrollToBottom]);

// // //   // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
// // //   useEffect(() => {
// // //     if (friend?.sender) {
// // //       socketRef.current = io("http://localhost:5000", {
// // //         query: { userId: friend.sender },
// // //       });

// // //       socketRef.current.on("receiveMessage", (data) => {
// // //         const receivedMessage = {
// // //           id: new Date().getTime() + Math.random(),
// // //           text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
// // //           type: data.message.sender === friend.sender ? "sent" : "received",
// // //           timestamp: new Date(data.message.timestamp),
// // //           image: data.message.message_type === "image" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
// // //           video: data.message.message_type === "video" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
// // //           file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
// // //           isTemporary: !!data.message.base64Data,
// // //         };

// // //         setMessages((prev) => [...prev, receivedMessage]);
// // //         scrollToBottom();
// // //       });

// // //       return () => {
// // //         if (socketRef.current) {
// // //           socketRef.current.disconnect();
// // //         }
// // //       };
// // //     }
// // //   }, [friend, scrollToBottom]);

// // //   // Fetch tin nh·∫Øn t·ª´ API
// // //   useEffect(() => {
// // //     const fetchMessages = async () => {
// // //       if (!friend || !friend.id) {
// // //         setMessages([]);
// // //         setLoading(false);
// // //         return;
// // //       }

// // //       try {
// // //         const response = await axios.post("http://localhost:5000/api/chat/messages/", {
// // //           friendId: friend.id,
// // //         });

// // //         if (response.status === 200 && Array.isArray(response.data)) {
// // //           const transformedMessages = response.data
// // //             .map((msg) => ({
// // //               id: msg.id,
// // //               text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
// // //               type: msg.sender === friend.sender ? "sent" : "received",
// // //               timestamp: new Date(msg.timestamp),
// // //               image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
// // //               video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
// // //               file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
// // //               isTemporary: false,
// // //             }))
// // //             .filter((msg) => msg.text || msg.image || msg.video || msg.file);

// // //           setMessages(transformedMessages);
// // //         } else {
// // //           setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
// // //         }
// // //       } catch (err) {
// // //         setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
// // //         console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
// // //       } finally {
// // //         setLoading(false);
// // //       }
// // //     };

// // //     fetchMessages();
// // //   }, [friend]);

// // //   const toggleRequestBar = useCallback(() => {
// // //     setShowSendRequestBar((prev) => !prev);
// // //   }, []);

// // //   const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

// // //   const handleEmoji = useCallback((emoji) => {
// // //     setText((prev) => prev + emoji);
// // //     setOpen(false);
// // //   }, []);

// // //   const handleSend = useCallback(async () => {
// // //     if (text.trim()) {
// // //       const newMessage = {
// // //         id: Date.now(),
// // //         text: text.trim(),
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         isTemporary: false,
// // //       };
// // //       setMessages((prev) => [...prev, newMessage]);
// // //       setText("");

// // //       if (socketRef.current) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: "",
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: newMessage.text,
// // //             message_type: "text",
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //           },
// // //         });
// // //       }

// // //       try {
// // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //           id: "",
// // //           conversationId: friend.id,
// // //           sender: friend.sender,
// // //           content: text.trim(),
// // //           message_type: "text",
// // //           timestamp: new Date().toISOString(),
// // //           recipient: friend.member,
// // //         });
// // //       } catch (error) {
// // //         console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
// // //       }
// // //     } else {
// // //       const likeMessage = {
// // //         id: Date.now(),
// // //         text: "üëç",
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         isTemporary: false,
// // //       };
// // //       setMessages((prev) => [...prev, likeMessage]);

// // //       if (socketRef.current) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: "",
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: "üëç",
// // //             message_type: "text",
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //           },
// // //         });
// // //       }

// // //       try {
// // //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //           id: "",
// // //           conversationId: friend.id,
// // //           sender: friend.sender,
// // //           content: "üëç",
// // //           message_type: "text",
// // //           timestamp: new Date().toISOString(),
// // //           recipient: friend.member,
// // //         });
// // //       } catch (error) {
// // //         console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
// // //       }
// // //     }
// // //   }, [text, friend]);

// // //   const handleKeyPress = useCallback((e) => {
// // //     if (e.key === "Enter") {
// // //       handleSend();
// // //     }
// // //   }, [handleSend]);

// // //   const handleAvatarClick = useCallback(() => {
// // //     setShowProFile(true);
// // //   }, []);

// // //   const handleMediaSelect = useCallback(async (e, mediaType) => {
// // //     const file = e.target.files[0];
// // //     if (!file) {
// // //       alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
// // //       return;
// // //     }

// // //     if (file.size > 50 * 1024 * 1024) {
// // //       alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
// // //       return;
// // //     }

// // //     if (mediaType === "image" && !file.type.startsWith("image/")) {
// // //       alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
// // //       return;
// // //     }

// // //     if (mediaType === "video" && !file.type.startsWith("video/")) {
// // //       alert("Vui l√≤ng ch·ªçn t·ªáp video.");
// // //       return;
// // //     }

// // //     const reader = new FileReader();
// // //     reader.onload = () => {
// // //       const tempMessageId = Date.now() + Math.random();
// // //       const tempMessage = {
// // //         id: tempMessageId,
// // //         type: "sent",
// // //         timestamp: new Date(),
// // //         uploading: true,
// // //         fileName: file.name,
// // //         isTemporary: true,
// // //       };

// // //       if (mediaType === "image") {
// // //         tempMessage.image = reader.result;
// // //       } else if (mediaType === "video") {
// // //         tempMessage.video = reader.result;
// // //       } else if (mediaType === "file") {
// // //         tempMessage.file = {
// // //           name: file.name,
// // //           url: reader.result,
// // //         };
// // //       }

// // //       setMessages((prev) => [...prev, tempMessage]);
// // //       scrollToBottom();

// // //       if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
// // //         socketRef.current.emit("sendMessage", {
// // //           toUserId: friend.member,
// // //           message: {
// // //             id: tempMessageId,
// // //             conversation_id: friend.id,
// // //             sender: friend.sender,
// // //             recipient: friend.member,
// // //             content: file.name,
// // //             message_type: mediaType,
// // //             timestamp: new Date().toISOString(),
// // //             url: null,
// // //             base64Data: reader.result,
// // //           },
// // //         });
// // //       }

// // //       uploadFileToServer(file, mediaType, tempMessageId);
// // //     };

// // //     reader.onerror = () => {
// // //       alert("L·ªói khi ƒë·ªçc t·ªáp.");
// // //     };
// // //     reader.readAsDataURL(file);
// // //   }, [friend, scrollToBottom]);

// // //   const uploadFileToServer = async (file, mediaType, messageId) => {
// // //     const formData = new FormData();
// // //     let endpoint;

// // //     if (mediaType === "image") {
// // //       formData.append("file", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-file";
// // //     } else if (mediaType === "video") {
// // //       formData.append("video", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-video";
// // //     } else if (mediaType === "file") {
// // //       formData.append("file", file, encodeURIComponent(file.name));
// // //       endpoint = "/upload-file";
// // //     }

// // //     try {
// // //       const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
// // //         headers: {
// // //           "Content-Type": "multipart/form-data",
// // //           "Accept": "application/json",
// // //         },
// // //       });

// // //       if (uploadResponse.data.url) {
// // //         const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");
// // //         const fullUrl = uploadResponse.data.url;

// // //         // C·∫≠p nh·∫≠t tin nh·∫Øn v·ªõi URL m·ªõi v√† x√≥a base64
// // //         setMessages((prev) =>
// // //           prev.map((msg) => {
// // //             if (msg.id === messageId) {
// // //               const updatedMsg = {
// // //                 ...msg,
// // //                 uploading: false,
// // //                 isTemporary: false,
// // //                 image: mediaType === "image" ? fullUrl : msg.image, // Ch·ªâ c·∫≠p nh·∫≠t image n·∫øu l√† ·∫£nh
// // //                 video: mediaType === "video" ? fullUrl : msg.video,
// // //                 file: mediaType === "file" ? { name: decodeURIComponent(file.name), url: fullUrl } : msg.file,
// // //               };
// // //               // X√≥a base64 t·∫°m th·ªùi ƒë·ªÉ tr√°nh xung ƒë·ªôt
// // //               if (mediaType === "image" && updatedMsg.image) delete updatedMsg.image.base64Data;
// // //               if (mediaType === "video" && updatedMsg.video) delete updatedMsg.video.base64Data;
// // //               return updatedMsg;
// // //             }
// // //             return msg;
// // //           })
// // //         );

// // //         if (socketRef.current) {
// // //           socketRef.current.emit("sendMessage", {
// // //             toUserId: friend.member,
// // //             message: {
// // //               id: "",
// // //               conversation_id: friend.id,
// // //               sender: friend.sender,
// // //               recipient: friend.member,
// // //               content: file.name,
// // //               message_type: mediaType,
// // //               timestamp: new Date().toISOString(),
// // //               url: filePath,
// // //             },
// // //           });
// // //         }

// // //         try {
// // //           await axios.post("http://localhost:5000/api/chat/send-message/", {
// // //             id: "",
// // //             conversationId: friend.id,
// // //             sender: friend.sender,
// // //             content: decodeURIComponent(file.name),
// // //             message_type: mediaType,
// // //             timestamp: new Date().toISOString(),
// // //             recipient: friend.member,
// // //             url: filePath,
// // //           });
// // //         } catch (messageError) {
// // //           console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
// // //         }
// // //       }
// // //     } catch (uploadError) {
// // //       setMessages((prev) =>
// // //         prev.map((msg) => {
// // //           if (msg.id === messageId) {
// // //             return {
// // //               ...msg,
// // //               uploading: false,
// // //               error: true,
// // //               isTemporary: false,
// // //             };
// // //           }
// // //           return msg;
// // //         })
// // //       );
// // //       alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
// // //     }
// // //   };

// // //   const handleSendFriendRequest = useCallback((friendId, friendName) => {
// // //     console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
// // //   }, []);

// // //   const handleConfirmFriendRequest = useCallback((friendId, friendName) => {
// // //     console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // //   }, []);

// // //   const handleRejectFriendRequest = useCallback((friendId, friendName) => {
// // //     console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// // //   }, []);

// // //   const handleClosePreview = useCallback(() => {
// // //     setPreviewImage(null);
// // //   }, []);

// // //   const isValidUrl = (url) => {
// // //     try {
// // //       new URL(url);
// // //       return true;
// // //     } catch {
// // //       return false;
// // //     }
// // //   };

// // //   const renderMessageContent = (message) => {
// // //     if (message.uploading) {
// // //       return (
// // //         <div className={cx("message-uploading")}>
// // //           <span>ƒêang t·∫£i {message.fileName}...</span>
// // //         </div>
// // //       );
// // //     }

// // //     if (message.error) {
// // //       return (
// // //         <div className={cx("message-error")}>
// // //           <span>L·ªói t·∫£i {message.fileName}</span>
// // //         </div>
// // //       );
// // //     }

// // //     // if (message.image) {
// // //     //   return (
// // //     //     <div
// // //     //       className={cx("message-image", { temporary: message.isTemporary })}
// // //     //       onClick={() => setPreviewImage(message.image)}
// // //     //       aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
// // //     //     >
// // //     //       <img
// // //     //         src={message.isTemporary ? message.image : (message.image.startsWith("http") ? message.image : `http://localhost:5000${message.image}`)}
// // //     //         //alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"}
// // //     //         className={cx("image-content")}
// // //     //         onError={(e) => console.error("L·ªói t·∫£i h√¨nh ·∫£nh:", e.target.src)}
// // //     //       />
// // //     //       {/*{message.isTemporary && (
// // //     //         <div className={cx("temporary-indicator")}>
// // //     //           <span>ƒêang x·ª≠ l√Ω...</span>
// // //     //         </div>
// // //     //       )}*/}
// // //     //     </div>
// // //     //   );
// // //     // }

// // //    // Ch·ªâ render ·∫£nh khi c√≥ ·∫£nh h·ª£p l·ªá
// // // if (message.image) {
// // //   const isBase64 = message.image.startsWith('data:image/');
// // //   const isValidImage = isBase64 ||
// // //     message.image.startsWith('http://') ||
// // //     message.image.startsWith('https://') ||
// // //     message.image.startsWith('/');

// // //   // S·ª≠a logic: ch·ªâ kh√¥ng render n·∫øu kh√¥ng ph·∫£i ·∫£nh h·ª£p l·ªá
// // //   // B·ªè ƒëi·ªÅu ki·ªán (message.isTemporary && !isBase64) v√¨ n√≥ ch·∫∑n ·∫£nh t·∫°m th·ªùi
// // //   if (!isValidImage) {
// // //     console.log('Invalid image format:', message.image); // Debug
// // //     return null;
// // //   }

// // //   return (
// // //     <div
// // //       className={cx("message-image")}
// // //       onClick={() => setPreviewImage(message.image)}
// // //       aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
// // //     >
// // //       <img
// // //         src={isBase64 ? message.image : (message.image.startsWith("http") ? message.image : `http://localhost:5000${message.image}`)}
// // //         alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"}
// // //         className={cx("image-content")}
// // //         onError={(e) => {
// // //           console.error("L·ªói t·∫£i h√¨nh ·∫£nh:", e.target.src);
// // //           e.target.parentElement.style.display = 'none';
// // //         }}
// // //       />
// // //       {/* Hi·ªÉn th·ªã indicator khi ƒëang upload */}
// // //       {message.uploading && (
// // //         <div className={cx("uploading-indicator")}>
// // //           ƒêang t·∫£i...
// // //         </div>
// // //       )}
// // //     </div>
// // //   );
// // // }

// // //     if (message.video) {
// // //       return (
// // //         <div className={cx("message-video", { temporary: message.isTemporary })}>
// // //           <video controls className={cx("video-content")}>
// // //             <source src={message.isTemporary ? message.video : (message.video.startsWith("http") ? message.video : `http://localhost:5000${message.video}`)} type="video/mp4" />
// // //             Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
// // //           </video>
// // //           {message.isTemporary && (
// // //             <div className={cx("temporary-indicator")}>
// // //               <span>ƒêang x·ª≠ l√Ω...</span>
// // //             </div>
// // //           )}
// // //         </div>
// // //       );
// // //     }

// // //     if (message.file) {
// // //       return (
// // //         <div className={cx("message-file")}>
// // //           <a href={message.file.url.startsWith("http") ? message.file.url : `http://localhost:5000${message.file.url}`} download={message.file.name}>
// // //             {message.file.name}
// // //           </a>
// // //         </div>
// // //       );
// // //     }

// // //     if (typeof message.text === "string" && message.text) {
// // //       const urlRegex = /(https?:\/\/[^\s]+)/g;
// // //       const parts = message.text.split(urlRegex);
// // //       return (
// // //         <span>
// // //           {parts.map((part, index) => {
// // //             if (part.match(urlRegex) && isValidUrl(part)) {
// // //               return (
// // //                 <a
// // //                   key={index}
// // //                   href={part}
// // //                   target="_blank"
// // //                   rel="noopener noreferrer"
// // //                   className={cx("message-link")}
// // //                 >
// // //                   {part}
// // //                 </a>
// // //               );
// // //             }
// // //             return part;
// // //           })}
// // //         </span>
// // //       );
// // //     }
// // //     return <span>{message.text || ""}</span>;
// // //   };

// // //   const formatTime = (dateObj) => {
// // //     return dateObj.toLocaleTimeString("vi-VN", {
// // //       hour: "2-digit",
// // //       minute: "2-digit",
// // //       hour12: true,
// // //     });
// // //   };

// // //   const formatSeparator = (dateObj) => {
// // //     return (
// // //       dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
// // //       " " +
// // //       formatTime(dateObj)
// // //     );
// // //   };

// // //   if (!friend) {
// // //     return (
// // //       <div className={cx("chat")}>
// // //         <div className={cx("empty-state")}>
// // //           <div className={cx("empty-content")}>
// // //             <div className={cx("empty-icon")}>
// // //               <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
// // //                 <path
// // //                   d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
// // //                   fill="currentColor"
// // //                   opacity="0.3"
// // //                 />
// // //                 <circle cx="8" cy="12" r="1" fill="currentColor" />
// // //                 <circle cx="12" cy="12" r="1" fill="currentColor" />
// // //                 <circle cx="16" cy="12" r="1" fill="currentColor" />
// // //               </svg>
// // //             </div>
// // //             <div className={cx("empty-text")}>
// // //               <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
// // //               <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
// // //             </div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   }

// // //   return (
// // //     <div className={cx("chat")}>
// // //       <ChatHeader friend={friend} onAvatarClick={handleAvatarClick} onToggleDetail={onToggleDetail} />

// // //       {showSendRequestBar ? (
// // //         <FriendRequestBar friend={friend} onSendRequest={handleSendFriendRequest} isVisible={false} />
// // //       ) : (
// // //         <FriendRequestConfirmationBar
// // //           friend={friend}
// // //           onConfirmRequest={handleConfirmFriendRequest}
// // //           onRejectRequest={handleRejectFriendRequest}
// // //           isVisible={false}
// // //         />
// // //       )}

// // //       <div className={cx("center")} ref={messagesContainerRef}>
// // //         {loading ? (
// // //           <div>ƒêang t·∫£i...</div>
// // //         ) : error ? (
// // //           <div className={cx("error")}>{error}</div>
// // //         ) : (
// // //           messages.map((message, index) => {
// // //             const prevMsg = messages[index - 1];
// // //             const nextMsg = messages[index + 1];
// // //             const currentTime = message.timestamp;

// // //             let showSeparator = false;
// // //             let showTime = false;

// // //             if (!prevMsg) {
// // //               showSeparator = true;
// // //             } else {
// // //               const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
// // //               if (diffMinutes >= 10) {
// // //                 showSeparator = true;
// // //               }
// // //             }

// // //             if (!nextMsg) {
// // //               showTime = true;
// // //             } else {
// // //               const sameMinute =
// // //                 currentTime.getHours() === nextMsg.timestamp.getHours() &&
// // //                 currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
// // //               if (!sameMinute) {
// // //                 showTime = true;
// // //               }
// // //             }

// // //             return (
// // //               <div key={message.id} className={cx("message-wrapper", message.type)}>
// // //                 {showSeparator && (
// // //                   <div className={cx("time-separator")}>
// // //                     <div className={cx("time-separator-content")}>
// // //                       {formatSeparator(message.timestamp)}
// // //                     </div>
// // //                   </div>
// // //                 )}
// // //                 <div className={cx("message", message.type)}>
// // //                   <div
// // //                     className={cx("message-bubble", {
// // //                       "has-media": message.image || message.video || message.file,
// // //                       temporary: message.isTemporary,
// // //                     })}
// // //                   >
// // //                     {renderMessageContent(message)}
// // //                   </div>
// // //                   {showTime && (
// // //                     <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
// // //                   )}
// // //                 </div>
// // //               </div>
// // //             );
// // //           })
// // //         )}
// // //       </div>

// // //       {previewImage && <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />}

// // //       <div className={cx("cr")}>
// // //         <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept="image/*"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "image")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
// // //           </svg>
// // //         </label>
// // //         <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept=".pdf,.doc,.docx,.txt"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "file")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
// // //           </svg>
// // //         </label>
// // //         <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
// // //           <input
// // //             type="file"
// // //             accept="video/*"
// // //             style={{ display: "none" }}
// // //             onChange={(e) => handleMediaSelect(e, "video")}
// // //           />
// // //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// // //             <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
// // //           </svg>
// // //         </label>
// // //       </div>

// // //       <div className={cx("input-area")}>
// // //         <input
// // //           type="text"
// // //           placeholder="Nh·∫≠p tin nh·∫Øn..."
// // //           value={text}
// // //           onChange={(e) => setText(e.target.value)}
// // //           onKeyPress={handleKeyPress}
// // //           className={cx("message-input")}
// // //           aria-label="Nh·∫≠p tin nh·∫Øn"
// // //         />
// // //         <div className={cx("emoji-container")}>
// // //           <button
// // //             className={cx("emoji-button")}
// // //             onClick={() => setOpen((prev) => !prev)}
// // //             aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
// // //           >
// // //             üòä
// // //           </button>
// // //           <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
// // //             {emojis.map((emoji, index) => (
// // //               <button
// // //                 key={index}
// // //                 onClick={() => handleEmoji(emoji)}
// // //                 className={cx("emoji-item")}
// // //                 aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
// // //               >
// // //                 {emoji}
// // //               </button>
// // //             ))}
// // //           </div>
// // //         </div>
// // //         <button
// // //           onClick={handleSend}
// // //           className={cx("send-button", { active: text.trim() })}
// // //           aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
// // //         >
// // //           {text.trim() ? (
// // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //               <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
// // //             </svg>
// // //           ) : (
// // //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //               <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
// // //             </svg>
// // //           )}
// // //         </button>
// // //       </div>

// // //       {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
// // //       {showProfile && <ProFile1 onClose={() => setShowProFile(false)} datax={friend} />}
// // //     </div>
// // //   );
// // // }

// // // export default Chat;


// // import classNames from "classnames/bind";
// // import styles from "./Chat.module.scss";
// // import { useState, useEffect, useRef, useCallback } from "react";
// // import ProFile1 from "~/pages/ProFile1";
// // import ChatPreview from "./ChatPreview";
// // import FriendRequestBar from "./FriendRequestBar";
// // import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
// // import ChatHeader from "./ChatHeader";
// // import axios from "axios";
// // import { io } from "socket.io-client";

// // const cx = classNames.bind(styles);

// // function Chat({ friend, onToggleDetail }) {
// //   const [open, setOpen] = useState(false);
// //   const [text, setText] = useState("");
// //   const [showProfile, setShowProFile] = useState(false);
// //   const [previewImage, setPreviewImage] = useState(null);
// //   const messagesContainerRef = useRef(null);
// //   const [messages, setMessages] = useState([]);
// //   const [loading, setLoading] = useState(true);
// //   const [error, setError] = useState(null);
// //   const [showSendRequestBar, setShowSendRequestBar] = useState(false);
// //   const socketRef = useRef(null);

// //   // H√†m cu·ªôn xu·ªëng cu·ªëi
// //   const scrollToBottom = useCallback(() => {
// //     if (messagesContainerRef.current) {
// //       messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
// //     }
// //   }, []);

// //   // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
// //   useEffect(() => {
// //     scrollToBottom();
// //   }, [messages, scrollToBottom]);

// //   // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
// //   useEffect(() => {
// //     if (friend?.sender) {
// //       socketRef.current = io("http://localhost:5000", {
// //         query: { userId: friend.sender },
// //       });

// //       socketRef.current.on("receiveMessage", (data) => {
// //         const receivedMessage = {
// //           id: new Date().getTime() + Math.random(),
// //           text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
// //           type: data.message.sender === friend.sender ? "sent" : "received",
// //           timestamp: new Date(data.message.timestamp),
// //           temporaryImage: data.message.message_type === "image" && data.message.base64Data ? data.message.base64Data : null,
// //           image: data.message.message_type === "image" && data.message.url ? `http://localhost:5000${data.message.url}` : null,
// //           video: data.message.message_type === "video" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
// //           file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
// //           isTemporary: !!data.message.base64Data,
// //         };

// //         setMessages((prev) => [...prev, receivedMessage]);
// //         scrollToBottom();
// //       });

// //       return () => {
// //         if (socketRef.current) {
// //           socketRef.current.disconnect();
// //         }
// //       };
// //     }
// //   }, [friend, scrollToBottom]);

// //   // Fetch tin nh·∫Øn t·ª´ API
// //   useEffect(() => {
// //     const fetchMessages = async () => {
// //       if (!friend || !friend.id) {
// //         setMessages([]);
// //         setLoading(false);
// //         return;
// //       }

// //       try {
// //         const response = await axios.post("http://localhost:5000/api/chat/messages/", {
// //           friendId: friend.id,
// //         });

// //         if (response.status === 200 && Array.isArray(response.data)) {
// //           const transformedMessages = response.data
// //             .map((msg) => ({
// //               id: msg.id,
// //               text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
// //               type: msg.sender === friend.sender ? "sent" : "received",
// //               timestamp: new Date(msg.timestamp),
// //               image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
// //               video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
// //               file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
// //               isTemporary: false,
// //             }))
// //             .filter((msg) => msg.text || msg.image || msg.video || msg.file);

// //           setMessages(transformedMessages);
// //         } else {
// //           setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
// //         }
// //       } catch (err) {
// //         setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
// //         console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
// //       } finally {
// //         setLoading(false);
// //       }
// //     };

// //     fetchMessages();
// //   }, [friend]);

// //   const toggleRequestBar = useCallback(() => {
// //     setShowSendRequestBar((prev) => !prev);
// //   }, []);

// //   const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

// //   const handleEmoji = useCallback((emoji) => {
// //     setText((prev) => prev + emoji);
// //     setOpen(false);
// //   }, []);

// //   const handleSend = useCallback(async () => {
// //     if (text.trim()) {
// //       const newMessage = {
// //         id: Date.now(),
// //         text: text.trim(),
// //         type: "sent",
// //         timestamp: new Date(),
// //         isTemporary: false,
// //       };
// //       setMessages((prev) => [...prev, newMessage]);
// //       setText("");

// //       if (socketRef.current) {
// //         socketRef.current.emit("sendMessage", {
// //           toUserId: friend.member,
// //           message: {
// //             id: "",
// //             conversation_id: friend.id,
// //             sender: friend.sender,
// //             recipient: friend.member,
// //             content: newMessage.text,
// //             message_type: "text",
// //             timestamp: new Date().toISOString(),
// //             url: null,
// //           },
// //         });
// //       }

// //       try {
// //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// //           id: "",
// //           conversationId: friend.id,
// //           sender: friend.sender,
// //           content: text.trim(),
// //           message_type: "text",
// //           timestamp: new Date().toISOString(),
// //           recipient: friend.member,
// //         });
// //       } catch (error) {
// //         console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
// //       }
// //     } else {
// //       const likeMessage = {
// //         id: Date.now(),
// //         text: "üëç",
// //         type: "sent",
// //         timestamp: new Date(),
// //         isTemporary: false,
// //       };
// //       setMessages((prev) => [...prev, likeMessage]);

// //       if (socketRef.current) {
// //         socketRef.current.emit("sendMessage", {
// //           toUserId: friend.member,
// //           message: {
// //             id: "",
// //             conversation_id: friend.id,
// //             sender: friend.sender,
// //             recipient: friend.member,
// //             content: "üëç",
// //             message_type: "text",
// //             timestamp: new Date().toISOString(),
// //             url: null,
// //           },
// //         });
// //       }

// //       try {
// //         await axios.post("http://localhost:5000/api/chat/send-message/", {
// //           id: "",
// //           conversationId: friend.id,
// //           sender: friend.sender,
// //           content: "üëç",
// //           message_type: "text",
// //           timestamp: new Date().toISOString(),
// //           recipient: friend.member,
// //         });
// //       } catch (error) {
// //         console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
// //       }
// //     }
// //   }, [text, friend]);

// //   const handleKeyPress = useCallback((e) => {
// //     if (e.key === "Enter") {
// //       handleSend();
// //     }
// //   }, [handleSend]);

// //   const handleAvatarClick = useCallback(() => {
// //     setShowProFile(true);
// //   }, []);

// //   const handleMediaSelect = useCallback(async (e, mediaType) => {
// //     const file = e.target.files[0];
// //     if (!file) {
// //       alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
// //       return;
// //     }

// //     if (file.size > 50 * 1024 * 1024) {
// //       alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
// //       return;
// //     }

// //     if (mediaType === "image" && !file.type.startsWith("image/")) {
// //       alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
// //       return;
// //     }

// //     if (mediaType === "video" && !file.type.startsWith("video/")) {
// //       alert("Vui l√≤ng ch·ªçn t·ªáp video.");
// //       return;
// //     }

// //     const reader = new FileReader();
// //     reader.onload = () => {
// //       const tempMessageId = Date.now() + Math.random();
// //       const tempMessage = {
// //         id: tempMessageId,
// //         type: "sent",
// //         timestamp: new Date(),
// //         uploading: true,
// //         fileName: file.name,
// //         isTemporary: true,
// //       };

// //       let base64Data = null;
// //       if (mediaType === "image") {
// //         tempMessage.temporaryImage = reader.result; // L∆∞u base64 v√†o temporaryImage
// //         base64Data = reader.result;
// //       } else if (mediaType === "video") {
// //         tempMessage.video = reader.result;
// //         base64Data = reader.result;
// //       } else if (mediaType === "file") {
// //         tempMessage.file = {
// //           name: file.name,
// //           url: reader.result,
// //         };
// //       }

// //       setMessages((prev) => [...prev, tempMessage]);
// //       scrollToBottom();

// //       if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
// //         socketRef.current.emit("sendMessage", {
// //           toUserId: friend.member,
// //           message: {
// //             id: tempMessageId,
// //             conversation_id: friend.id,
// //             sender: friend.sender,
// //             recipient: friend.member,
// //             content: file.name,
// //             message_type: mediaType,
// //             timestamp: new Date().toISOString(),
// //             url: null,
// //             base64Data: base64Data,
// //           },
// //         });
// //       }

// //       uploadFileToServer(file, mediaType, tempMessageId, base64Data);
// //     };

// //     reader.onerror = () => {
// //       alert("L·ªói khi ƒë·ªçc t·ªáp.");
// //     };
// //     reader.readAsDataURL(file);
// //   }, [friend, scrollToBottom]);

// //   const uploadFileToServer = async (file, mediaType, messageId, base64Data = null) => {
// //     const formData = new FormData();
// //     let endpoint;

// //     if (mediaType === "image") {
// //       formData.append("file", file, encodeURIComponent(file.name));
// //       endpoint = "/upload-file";
// //     } else if (mediaType === "video") {
// //       formData.append("video", file, encodeURIComponent(file.name));
// //       endpoint = "/upload-video";
// //     } else if (mediaType === "file") {
// //       formData.append("file", file, encodeURIComponent(file.name));
// //       endpoint = "/upload-file";
// //     }

// //     try {
// //       const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
// //         headers: {
// //           "Content-Type": "multipart/form-data",
// //           "Accept": "application/json",
// //         },
// //       });

// //       if (uploadResponse.data.url) {
// //         const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");
// //         const fullUrl = uploadResponse.data.url;

// //         setMessages((prev) =>
// //           prev.map((msg) => {
// //             if (msg.id === messageId) {
// //               const updatedMsg = {
// //                 ...msg,
// //                 uploading: false,
// //                 isTemporary: false,
// //                 image: mediaType === "image" ? fullUrl : msg.image,
// //                 video: mediaType === "video" ? fullUrl : msg.video,
// //                 file: mediaType === "file" ? { name: decodeURIComponent(file.name), url: fullUrl } : msg.file,
// //               };
// //               return updatedMsg;
// //             }
// //             return msg;
// //           })
// //         );

// //         if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
// //           socketRef.current.emit("sendMessage", {
// //             toUserId: friend.member,
// //             message: {
// //               id: "",
// //               conversation_id: friend.id,
// //               sender: friend.sender,
// //               recipient: friend.member,
// //               content: file.name,
// //               message_type: mediaType,
// //               timestamp: new Date().toISOString(),
// //               url: filePath,
// //               base64Data: base64Data,
// //             },
// //           });
// //         }

// //         try {
// //           await axios.post("http://localhost:5000/api/chat/send-message/", {
// //             id: "",
// //             conversationId: friend.id,
// //             sender: friend.sender,
// //             content: decodeURIComponent(file.name),
// //             message_type: mediaType,
// //             timestamp: new Date().toISOString(),
// //             recipient: friend.member,
// //             url: filePath,
// //           });
// //         } catch (messageError) {
// //           console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
// //         }
// //       }
// //     } catch (uploadError) {
// //       setMessages((prev) =>
// //         prev.map((msg) => {
// //           if (msg.id === messageId) {
// //             return {
// //               ...msg,
// //               uploading: false,
// //               error: true,
// //               isTemporary: false,
// //             };
// //           }
// //           return msg;
// //         })
// //       );
// //       alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
// //     }
// //   };

// //   const handleSendFriendRequest = useCallback((friendId, friendName) => {
// //     console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
// //   }, []);

// //   const handleConfirmFriendRequest = useCallback((friendId, friendName) => {
// //     console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// //   }, []);

// //   const handleRejectFriendRequest = useCallback((friendId, friendName) => {
// //     console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
// //   }, []);

// //   const handleClosePreview = useCallback(() => {
// //     setPreviewImage(null);
// //   }, []);

// //   const isValidUrl = (url) => {
// //     try {
// //       new URL(url);
// //       return true;
// //     } catch {
// //       return false;
// //     }
// //   };

// //   const renderMessageContent = (message) => {
// //     if (message.uploading) {
// //       return (
// //         <div className={cx("message-uploading")}>
// //           <span>ƒêang t·∫£i {message.fileName}...</span>
// //         </div>
// //       );
// //     }

// //     if (message.error) {
// //       return (
// //         <div className={cx("message-error")}>
// //           <span>L·ªói t·∫£i {message.fileName}</span>
// //         </div>
// //       );
// //     }

// //     if (message.temporaryImage || message.image) {
// //       const imageSource = message.temporaryImage || message.image;
// //       const isBase64 = imageSource && imageSource.startsWith("data:image/");

// //       return (
// //         <div
// //           className={cx("message-image", { temporary: message.isTemporary })}
// //           onClick={() => setPreviewImage(imageSource)}
// //           aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
// //         >
// //           <img
// //             src={
// //               isBase64
// //                 ? imageSource
// //                 : imageSource && imageSource.startsWith("http")
// //                 ? imageSource
// //                 : `http://localhost:5000${imageSource}`
// //             }
// //             alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"}
// //             className={cx("image-content")}
// //             onError={(e) => {
// //               console.error("L·ªói t·∫£i:", e.target.src);
// //               e.target.parentElement.style.display = "none";
// //             }}
// //           />
// //           {message.uploading && (
// //             <div className={cx("uploading-indicator")}>
// //               ƒêang t·∫£i...
// //             </div>
// //           )}
// //         </div>
// //       );
// //     }

// //     if (message.video) {
// //       return (
// //         <div className={cx("message-video", { temporary: message.isTemporary })}>
// //           <video controls className={cx("video-content")}>
// //             <source
// //               src={
// //                 message.isTemporary
// //                   ? message.video
// //                   : message.video.startsWith("http")
// //                   ? message.video
// //                   : `http://localhost:5000${message.video}`
// //               }
// //               type="video/mp4"
// //             />
// //             Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
// //           </video>
// //           {message.isTemporary && (
// //             <div className={cx("temporary-indicator")}>
// //               <span>ƒêang x·ª≠ l√Ω...</span>
// //             </div>
// //           )}
// //         </div>
// //       );
// //     }

// //     if (message.file) {
// //       return (
// //         <div className={cx("message-file")}>
// //           <a
// //             href={
// //               message.file.url.startsWith("http")
// //                 ? message.file.url
// //                 : `http://localhost:5000${message.file.url}`
// //             }
// //             download={message.file.name}
// //           >
// //             {message.file.name}
// //           </a>
// //         </div>
// //       );
// //     }

// //     if (typeof message.text === "string" && message.text) {
// //       const urlRegex = /(https?:\/\/[^\s]+)/g;
// //       const parts = message.text.split(urlRegex);
// //       return (
// //         <span>
// //           {parts.map((part, index) => {
// //             if (part.match(urlRegex) && isValidUrl(part)) {
// //               return (
// //                 <a
// //                   key={index}
// //                   href={part}
// //                   target="_blank"
// //                   rel="noopener noreferrer"
// //                   className={cx("message-link")}
// //                 >
// //                   {part}
// //                 </a>
// //               );
// //             }
// //             return part;
// //           })}
// //         </span>
// //       );
// //     }
// //     return <span>{message.text || ""}</span>;
// //   };

// //   const formatTime = (dateObj) => {
// //     return dateObj.toLocaleTimeString("vi-VN", {
// //       hour: "2-digit",
// //       minute: "2-digit",
// //       hour12: true,
// //     });
// //   };

// //   const formatSeparator = (dateObj) => {
// //     return (
// //       dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
// //       " " +
// //       formatTime(dateObj)
// //     );
// //   };

// //   if (!friend) {
// //     return (
// //       <div className={cx("chat")}>
// //         <div className={cx("empty-state")}>
// //           <div className={cx("empty-content")}>
// //             <div className={cx("empty-icon")}>
// //               <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
// //                 <path
// //                   d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
// //                   fill="currentColor"
// //                   opacity="0.3"
// //                 />
// //                 <circle cx="8" cy="12" r="1" fill="currentColor" />
// //                 <circle cx="12" cy="12" r="1" fill="currentColor" />
// //                 <circle cx="16" cy="12" r="1" fill="currentColor" />
// //               </svg>
// //             </div>
// //             <div className={cx("empty-text")}>
// //               <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
// //               <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
// //             </div>
// //           </div>
// //         </div>
// //       </div>
// //     );
// //   }

// //   return (
// //     <div className={cx("chat")}>
// //       <ChatHeader friend={friend} onAvatarClick={handleAvatarClick} onToggleDetail={onToggleDetail} />

// //       {showSendRequestBar ? (
// //         <FriendRequestBar friend={friend} onSendRequest={handleSendFriendRequest} isVisible={false} />
// //       ) : (
// //         <FriendRequestConfirmationBar
// //           friend={friend}
// //           onConfirmRequest={handleConfirmFriendRequest}
// //           onRejectRequest={handleRejectFriendRequest}
// //           isVisible={false}
// //         />
// //       )}

// //       <div className={cx("center")} ref={messagesContainerRef}>
// //         {loading ? (
// //           <div>ƒêang t·∫£i...</div>
// //         ) : error ? (
// //           <div className={cx("error")}>{error}</div>
// //         ) : (
// //           messages.map((message, index) => {
// //             const prevMsg = messages[index - 1];
// //             const nextMsg = messages[index + 1];
// //             const currentTime = message.timestamp;

// //             let showSeparator = false;
// //             let showTime = false;

// //             if (!prevMsg) {
// //               showSeparator = true;
// //             } else {
// //               const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
// //               if (diffMinutes >= 10) {
// //                 showSeparator = true;
// //               }
// //             }

// //             if (!nextMsg) {
// //               showTime = true;
// //             } else {
// //               const sameMinute =
// //                 currentTime.getHours() === nextMsg.timestamp.getHours() &&
// //                 currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
// //               if (!sameMinute) {
// //                 showTime = true;
// //               }
// //             }

// //             return (
// //               <div key={message.id} className={cx("message-wrapper", message.type)}>
// //                 {showSeparator && (
// //                   <div className={cx("time-separator")}>
// //                     <div className={cx("time-separator-content")}>
// //                       {formatSeparator(message.timestamp)}
// //                     </div>
// //                   </div>
// //                 )}
// //                 <div className={cx("message", message.type)}>
// //                   <div
// //                     className={cx("message-bubble", {
// //                       "has-media": message.temporaryImage || message.image || message.video || message.file,
// //                       temporary: message.isTemporary,
// //                     })}
// //                   >
// //                     {renderMessageContent(message)}
// //                   </div>
// //                   {showTime && (
// //                     <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
// //                   )}
// //                 </div>
// //               </div>
// //             );
// //           })
// //         )}
// //       </div>

// //       {previewImage && <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />}

// //       <div className={cx("cr")}>
// //         <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
// //           <input
// //             type="file"
// //             accept="image/*"
// //             style={{ display: "none" }}
// //             onChange={(e) => handleMediaSelect(e, "image")}
// //           />
// //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// //             <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
// //           </svg>
// //         </label>
// //         <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
// //           <input
// //             type="file"
// //             accept=".pdf,.doc,.docx,.txt"
// //             style={{ display: "none" }}
// //             onChange={(e) => handleMediaSelect(e, "file")}
// //           />
// //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// //             <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
// //           </svg>
// //         </label>
// //         <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
// //           <input
// //             type="file"
// //             accept="video/*"
// //             style={{ display: "none" }}
// //             onChange={(e) => handleMediaSelect(e, "video")}
// //           />
// //           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
// //             <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
// //           </svg>
// //         </label>
// //       </div>

// //       <div className={cx("input-area")}>
// //         <input
// //           type="text"
// //           placeholder="Nh·∫≠p tin nh·∫Øn..."
// //           value={text}
// //           onChange={(e) => setText(e.target.value)}
// //           onKeyPress={handleKeyPress}
// //           className={cx("message-input")}
// //           aria-label="Nh·∫≠p tin nh·∫Øn"
// //         />
// //         <div className={cx("emoji-container")}>
// //           <button
// //             className={cx("emoji-button")}
// //             onClick={() => setOpen((prev) => !prev)}
// //             aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
// //           >
// //             üòä
// //           </button>
// //           <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
// //             {emojis.map((emoji, index) => (
// //               <button
// //                 key={index}
// //                 onClick={() => handleEmoji(emoji)}
// //                 className={cx("emoji-item")}
// //                 aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
// //               >
// //                 {emoji}
// //               </button>
// //             ))}
// //           </div>
// //         </div>
// //         <button
// //           onClick={handleSend}
// //           className={cx("send-button", { active: text.trim() })}
// //           aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
// //         >
// //           {text.trim() ? (
// //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// //               <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
// //             </svg>
// //           ) : (
// //             <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// //               <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
// //             </svg>
// //           )}
// //         </button>
// //       </div>

// //       {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
// //       {showProfile && <ProFile1 onClose={() => setShowProFile(false)} datax={friend} />}
// //     </div>
// //   );
// // }

// // export default Chat;
// //Perfect

// import classNames from "classnames/bind";
// import styles from "./Chat.module.scss";
// import { useState, useEffect, useRef, useCallback } from "react";
// import ProFile1 from "~/pages/ProFile1";
// import ChatPreview from "./ChatPreview";
// import FriendRequestBar from "./FriendRequestBar";
// import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
// import ChatHeader from "./ChatHeader";
// import axios from "axios";
// import { io } from "socket.io-client";

// const cx = classNames.bind(styles);

// function Chat({ friend, onToggleDetail }) {
//   const [open, setOpen] = useState(false);
//   const [text, setText] = useState("");
//   const [showProfile, setShowProFile] = useState(false);
//   const [previewImage, setPreviewImage] = useState(null);
//   const messagesContainerRef = useRef(null);
//   const [messages, setMessages] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [error, setError] = useState(null);
//   const [showSendRequestBar, setShowSendRequestBar] = useState(false);
//   const socketRef = useRef(null);

//   // H√†m cu·ªôn xu·ªëng cu·ªëi
//   const scrollToBottom = useCallback(() => {
//     if (messagesContainerRef.current) {
//       messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
//     }
//   }, []);

//   // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
//   useEffect(() => {
//     scrollToBottom();
//   }, [messages, scrollToBottom]);

//   // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
//   useEffect(() => {
//     if (friend?.sender) {
//       socketRef.current = io("http://localhost:5000", {
//         query: { userId: friend.sender },
//       });

//       socketRef.current.on("receiveMessage", (data) => {
//         const receivedMessage = {
//           id: data.message.id || new Date().getTime() + Math.random(),
//           text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
//           type: data.message.sender === friend.sender ? "sent" : "received",
//           timestamp: new Date(data.message.timestamp),
//           temporaryImage: data.message.message_type === "image" && data.message.base64Data ? data.message.base64Data : null,
//           image: data.message.message_type === "image" && data.message.url ? `http://localhost:5000${data.message.url}` : null,
//           video: data.message.message_type === "video" ? (data.message.base64Data || `http://localhost:5000${data.message.url}`) : null,
//           file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
//           isTemporary: !!data.message.base64Data,
//         };

//         setMessages((prev) => {
//           // Ki·ªÉm tra n·∫øu tin nh·∫Øn ƒë√£ t·ªìn t·∫°i (d·ª±a tr√™n id)
//           const existingMessageIndex = prev.findIndex((msg) => msg.id === receivedMessage.id);
//           if (existingMessageIndex !== -1) {
//             // C·∫≠p nh·∫≠t tin nh·∫Øn hi·ªán c√≥
//             const updatedMessages = [...prev];
//             updatedMessages[existingMessageIndex] = {
//               ...updatedMessages[existingMessageIndex],
//               image: receivedMessage.image || updatedMessages[existingMessageIndex].image,
//               video: receivedMessage.video || updatedMessages[existingMessageIndex].video,
//               isTemporary: false,
//             };
//             return updatedMessages;
//           }
//           // Th√™m tin nh·∫Øn m·ªõi
//           return [...prev, receivedMessage];
//         });
//         scrollToBottom();
//       });

//       socketRef.current.on("updateMessage", (data) => {
//         setMessages((prev) =>
//           prev.map((msg) => {
//             if (msg.id === data.message.id) {
//               return {
//                 ...msg,
//                 image: data.message.url ? `http://localhost:5000${data.message.url}` : msg.image,
//                 video: data.message.url ? `http://localhost:5000${data.message.url}` : msg.video,
//                 isTemporary: false,
//               };
//             }
//             return msg;
//           })
//         );
//         scrollToBottom();
//       });

//       return () => {
//         if (socketRef.current) {
//           socketRef.current.disconnect();
//         }
//       };
//     }
//   }, [friend, scrollToBottom]);

//   // Fetch tin nh·∫Øn t·ª´ API
//   useEffect(() => {
//     const fetchMessages = async () => {
//       if (!friend || !friend.id) {
//         setMessages([]);
//         setLoading(false);
//         return;
//       }

//       try {
//         const response = await axios.post("http://localhost:5000/api/chat/messages/", {
//           friendId: friend.id,
//         });

//         if (response.status === 200 && Array.isArray(response.data)) {
//           const transformedMessages = response.data
//             .map((msg) => ({
//               id: msg.id,
//               text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
//               type: msg.sender === friend.sender ? "sent" : "received",
//               timestamp: new Date(msg.timestamp),
//               image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
//               video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
//               file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
//               isTemporary: false,
//             }))
//             .filter((msg) => msg.text || msg.image || msg.video || msg.file);

//           setMessages(transformedMessages);
//         } else {
//           setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
//         }
//       } catch (err) {
//         setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
//         console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
//       } finally {
//         setLoading(false);
//       }
//     };

//     fetchMessages();
//   }, [friend]);

//   const toggleRequestBar = useCallback(() => {
//     setShowSendRequestBar((prev) => !prev);
//   }, []);

//   const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

//   const handleEmoji = useCallback((emoji) => {
//     setText((prev) => prev + emoji);
//     setOpen(false);
//   }, []);

//   const handleSend = useCallback(async () => {
//     if (text.trim()) {
//       const newMessage = {
//         id: Date.now(),
//         text: text.trim(),
//         type: "sent",
//         timestamp: new Date(),
//         isTemporary: false,
//       };
//       setMessages((prev) => [...prev, newMessage]);
//       setText("");

//       if (socketRef.current) {
//         socketRef.current.emit("sendMessage", {
//           toUserId: friend.member,
//           message: {
//             id: newMessage.id,
//             conversation_id: friend.id,
//             sender: friend.sender,
//             recipient: friend.member,
//             content: newMessage.text,
//             message_type: "text",
//             timestamp: new Date().toISOString(),
//             url: null,
//           },
//         });
//       }

//       try {
//         await axios.post("http://localhost:5000/api/chat/send-message/", {
//           id: newMessage.id,
//           conversationId: friend.id,
//           sender: friend.sender,
//           content: text.trim(),
//           message_type: "text",
//           timestamp: new Date().toISOString(),
//           recipient: friend.member,
//         });
//       } catch (error) {
//         console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
//       }
//     } else {
//       const likeMessage = {
//         id: Date.now(),
//         text: "üëç",
//         type: "sent",
//         timestamp: new Date(),
//         isTemporary: false,
//       };
//       setMessages((prev) => [...prev, likeMessage]);

//       if (socketRef.current) {
//         socketRef.current.emit("sendMessage", {
//           toUserId: friend.member,
//           message: {
//             id: likeMessage.id,
//             conversation_id: friend.id,
//             sender: friend.sender,
//             recipient: friend.member,
//             content: "üëç",
//             message_type: "text",
//             timestamp: new Date().toISOString(),
//             url: null,
//           },
//         });
//       }

//       try {
//         await axios.post("http://localhost:5000/api/chat/send-message/", {
//           id: likeMessage.id,
//           conversationId: friend.id,
//           sender: friend.sender,
//           content: "üëç",
//           message_type: "text",
//           timestamp: new Date().toISOString(),
//           recipient: friend.member,
//         });
//       } catch (error) {
//         console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
//       }
//     }
//   }, [text, friend]);

//   const handleKeyPress = useCallback((e) => {
//     if (e.key === "Enter") {
//       handleSend();
//     }
//   }, [handleSend]);

//   const handleAvatarClick = useCallback(() => {
//     setShowProFile(true);
//   }, []);

//   const handleMediaSelect = useCallback(async (e, mediaType) => {
//     const file = e.target.files[0];
//     if (!file) {
//       alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
//       return;
//     }

//     if (file.size > 50 * 1024 * 1024) {
//       alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
//       return;
//     }

//     if (mediaType === "image" && !file.type.startsWith("image/")) {
//       alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
//       return;
//     }

//     if (mediaType === "video" && !file.type.startsWith("video/")) {
//       alert("Vui l√≤ng ch·ªçn t·ªáp video.");
//       return;
//     }

//     const reader = new FileReader();
//     reader.onload = () => {
//       const tempMessageId = Date.now() + Math.random();
//       const tempMessage = {
//         id: tempMessageId,
//         type: "sent",
//         timestamp: new Date(),
//         uploading: true,
//         fileName: file.name,
//         isTemporary: true,
//       };

//       let base64Data = null;
//       if (mediaType === "image") {
//         tempMessage.temporaryImage = reader.result;
//         base64Data = reader.result;
//       } else if (mediaType === "video") {
//         tempMessage.video = reader.result;
//         base64Data = reader.result;
//       } else if (mediaType === "file") {
//         tempMessage.file = {
//           name: file.name,
//           url: reader.result,
//         };
//       }

//       setMessages((prev) => [...prev, tempMessage]);
//       scrollToBottom();

//       if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
//         socketRef.current.emit("sendMessage", {
//           toUserId: friend.member,
//           message: {
//             id: tempMessageId,
//             conversation_id: friend.id,
//             sender: friend.sender,
//             recipient: friend.member,
//             content: file.name,
//             message_type: mediaType,
//             timestamp: new Date().toISOString(),
//             url: null,
//             base64Data: base64Data,
//           },
//         });
//       }

//       uploadFileToServer(file, mediaType, tempMessageId, base64Data);
//     };

//     reader.onerror = () => {
//       alert("L·ªói khi ƒë·ªçc t·ªáp.");
//     };
//     reader.readAsDataURL(file);
//   }, [friend, scrollToBottom]);

//   const uploadFileToServer = async (file, mediaType, messageId, base64Data = null) => {
//     const formData = new FormData();
//     let endpoint;

//     if (mediaType === "image") {
//       formData.append("file", file, encodeURIComponent(file.name));
//       endpoint = "/upload-file";
//     } else if (mediaType === "video") {
//       formData.append("video", file, encodeURIComponent(file.name));
//       endpoint = "/upload-video";
//     } else if (mediaType === "file") {
//       formData.append("file", file, encodeURIComponent(file.name));
//       endpoint = "/upload-file";
//     }

//     try {
//       const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
//         headers: {
//           "Content-Type": "multipart/form-data",
//           "Accept": "application/json",
//         },
//       });

//       if (uploadResponse.data.url) {
//         const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");
//         const fullUrl = uploadResponse.data.url;

//         setMessages((prev) =>
//           prev.map((msg) => {
//             if (msg.id === messageId) {
//               const updatedMsg = {
//                 ...msg,
//                 uploading: false,
//                 isTemporary: false,
//                 image: mediaType === "image" ? fullUrl : msg.image,
//                 video: mediaType === "video" ? fullUrl : msg.video,
//                 file: mediaType === "file" ? { name: decodeURIComponent(file.name), url: fullUrl } : msg.file,
//               };
//               return updatedMsg;
//             }
//             return msg;
//           })
//         );

//         if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
//           socketRef.current.emit("updateMessage", {
//             toUserId: friend.member,
//             message: {
//               id: messageId,
//               conversation_id: friend.id,
//               url: filePath,
//             },
//           });
//         }

//         try {
//           await axios.post("http://localhost:5000/api/chat/send-message/", {
//             id: messageId,
//             conversationId: friend.id,
//             sender: friend.sender,
//             content: decodeURIComponent(file.name),
//             message_type: mediaType,
//             timestamp: new Date().toISOString(),
//             recipient: friend.member,
//             url: filePath,
//           });
//         } catch (messageError) {
//           console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
//         }
//       }
//     } catch (uploadError) {
//       setMessages((prev) =>
//         prev.map((msg) => {
//           if (msg.id === messageId) {
//             return {
//               ...msg,
//               uploading: false,
//               error: true,
//               isTemporary: false,
//             };
//           }
//           return msg;
//         })
//       );
//       alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
//     }
//   };

//   const handleSendFriendRequest = useCallback((friendId, friendName) => {
//     console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
//   }, []);

//   const handleConfirmFriendRequest = useCallback((friendId, friendName) => {
//     console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
//   }, []);

//   const handleRejectFriendRequest = useCallback((friendId, friendName) => {
//     console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
//   }, []);

//   const handleClosePreview = useCallback(() => {
//     setPreviewImage(null);
//   }, []);

//   const isValidUrl = (url) => {
//     try {
//       new URL(url);
//       return true;
//     } catch {
//       return false;
//     }
//   };

//   const renderMessageContent = (message) => {
//     if (message.uploading) {
//       return (
//         <div className={cx("message-uploading")}>
//           <span>ƒêang t·∫£i {message.fileName}...</span>
//         </div>
//       );
//     }

//     if (message.error) {
//       return (
//         <div className={cx("message-error")}>
//         <span>L·ªói t·∫£i {message.fileName}</span>
//       </div>
//     );
//   }

//   if (message.temporaryImage || message.image) {
//     const imageSource = message.temporaryImage || message.image;
//     const isBase64 = imageSource && imageSource.startsWith("data:image/");

//     return (
//       <div
//         className={cx("message-image", { temporary: message.isTemporary })}
//         onClick={() => setPreviewImage(imageSource)}
//         aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
//       >
//         <img
//           src={
//             isBase64
//               ? imageSource
//               : imageSource && imageSource.startsWith("http")
//               ? imageSource
//               : `http://localhost:5000${imageSource}`
//           }
//           alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"}
//           className={cx("image-content")}
//           onError={(e) => {
//             console.error("L·ªói t·∫£i:", e.target.src);
//             e.target.parentElement.style.display = "none";
//           }}
//         />
//         {message.uploading && (
//           <div className={cx("uploading-indicator")}>
//             ƒêang t·∫£i...
//           </div>
//         )}
//       </div>
//     );
//   }

//   if (message.video) {
//     return (
//       <div className={cx("message-video", { temporary: message.isTemporary })}>
//         <video controls className={cx("video-content")}>
//           <source
//             src={
//               message.isTemporary
//                 ? message.video
//                 : message.video.startsWith("http")
//                 ? message.video
//                 : `http://localhost:5000${message.video}`
//             }
//             type="video/mp4"
//           />
//           Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
//         </video>
//         {message.isTemporary && (
//           <div className={cx("temporary-indicator")}>
//             <span>ƒêang x·ª≠ l√Ω...</span>
//           </div>
//         )}
//       </div>
//     );
//   }

//   if (message.file) {
//     return (
//       <div className={cx("message-file")}>
//         <a
//           href={
//             message.file.url.startsWith("http")
//               ? message.file.url
//               : `http://localhost:5000${message.file.url}`
//           }
//           download={message.file.name}
//         >
//           {message.file.name}
//         </a>
//       </div>
//     );
//   }

//   if (typeof message.text === "string" && message.text) {
//     const urlRegex = /(https?:\/\/[^\s]+)/g;
//     const parts = message.text.split(urlRegex);
//     return (
//       <span>
//         {parts.map((part, index) => {
//           if (part.match(urlRegex) && isValidUrl(part)) {
//             return (
//               <a
//                 key={index}
//                 href={part}
//                 target="_blank"
//                 rel="noopener noreferrer"
//                 className={cx("message-link")}
//               >
//                 {part}
//               </a>
//             );
//           }
//           return part;
//         })}
//       </span>
//     );
//   }
//   return <span>{message.text || ""}</span>;
// };

// const formatTime = (dateObj) => {
//   return dateObj.toLocaleTimeString("vi-VN", {
//     hour: "2-digit",
//     minute: "2-digit",
//     hour12: true,
//   });
// };

// const formatSeparator = (dateObj) => {
//   return (
//     dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
//     " " +
//     formatTime(dateObj)
//   );
// };

// if (!friend) {
//   return (
//     <div className={cx("chat")}>
//       <div className={cx("empty-state")}>
//         <div className={cx("empty-content")}>
//           <div className={cx("empty-icon")}>
//             <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
//               <path
//                 d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
//                 fill="currentColor"
//                 opacity="0.3"
//               />
//               <circle cx="8" cy="12" r="1" fill="currentColor" />
//               <circle cx="12" cy="12" r="1" fill="currentColor" />
//               <circle cx="16" cy="12" r="1" fill="currentColor" />
//             </svg>
//           </div>
//           <div className={cx("empty-text")}>
//             <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
//             <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// }

// return (
//   <div className={cx("chat")}>
//     <ChatHeader friend={friend} onAvatarClick={handleAvatarClick} onToggleDetail={onToggleDetail} />

//     {showSendRequestBar ? (
//       <FriendRequestBar friend={friend} onSendRequest={handleSendFriendRequest} isVisible={false} />
//     ) : (
//       <FriendRequestConfirmationBar
//         friend={friend}
//         onConfirmRequest={handleConfirmFriendRequest}
//         onRejectRequest={handleRejectFriendRequest}
//         isVisible={false}
//       />
//     )}

//     <div className={cx("center")} ref={messagesContainerRef}>
//       {loading ? (
//         <div>ƒêang t·∫£i...</div>
//       ) : error ? (
//         <div className={cx("error")}>{error}</div>
//       ) : (
//         messages.map((message, index) => {
//           const prevMsg = messages[index - 1];
//           const nextMsg = messages[index + 1];
//           const currentTime = message.timestamp;

//           let showSeparator = false;
//           let showTime = false;

//           if (!prevMsg) {
//             showSeparator = true;
//           } else {
//             const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
//             if (diffMinutes >= 10) {
//               showSeparator = true;
//             }
//           }

//           if (!nextMsg) {
//             showTime = true;
//           } else {
//             const sameMinute =
//               currentTime.getHours() === nextMsg.timestamp.getHours() &&
//               currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
//             if (!sameMinute) {
//               showTime = true;
//             }
//           }

//           return (
//             <div key={message.id} className={cx("message-wrapper", message.type)}>
//               {showSeparator && (
//                 <div className={cx("time-separator")}>
//                   <div className={cx("time-separator-content")}>
//                     {formatSeparator(message.timestamp)}
//                   </div>
//                 </div>
//               )}
//               <div className={cx("message", message.type)}>
//                 <div
//                   className={cx("message-bubble", {
//                     "has-media": message.temporaryImage || message.image || message.video || message.file,
//                     temporary: message.isTemporary,
//                   })}
//                 >
//                   {renderMessageContent(message)}
//                 </div>
//                 {showTime && (
//                   <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
//                 )}
//               </div>
//             </div>
//           );
//         })
//       )}
//     </div>

//     {previewImage && <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />}

//     <div className={cx("cr")}>
//       <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
//         <input
//           type="file"
//           accept="image/*"
//           style={{ display: "none" }}
//           onChange={(e) => handleMediaSelect(e, "image")}
//         />
//         <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
//           <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
//         </svg>
//       </label>
//       <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
//         <input
//           type="file"
//           accept=".pdf,.doc,.docx,.txt"
//           style={{ display: "none" }}
//           onChange={(e) => handleMediaSelect(e, "file")}
//         />
//         <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
//           <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
//         </svg>
//       </label>
//       <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
//         <input
//           type="file"
//           accept="video/*"
//           style={{ display: "none" }}
//           onChange={(e) => handleMediaSelect(e, "video")}
//         />
//         <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
//           <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
//         </svg>
//       </label>
//     </div>

//     <div className={cx("input-area")}>
//       <input
//         type="text"
//         placeholder="Nh·∫≠p tin nh·∫Øn..."
//         value={text}
//         onChange={(e) => setText(e.target.value)}
//         onKeyPress={handleKeyPress}
//         className={cx("message-input")}
//         aria-label="Nh·∫≠p tin nh·∫Øn"
//       />
//       <div className={cx("emoji-container")}>
//         <button
//           className={cx("emoji-button")}
//           onClick={() => setOpen((prev) => !prev)}
//           aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
//         >
//           üòä
//         </button>
//         <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
//           {emojis.map((emoji, index) => (
//             <button
//               key={index}
//               onClick={() => handleEmoji(emoji)}
//               className={cx("emoji-item")}
//               aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
//             >
//               {emoji}
//             </button>
//           ))}
//         </div>
//       </div>
//       <button
//         onClick={handleSend}
//         className={cx("send-button", { active: text.trim() })}
//         aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
//       >
//         {text.trim() ? (
//           <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//             <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
//           </svg>
//         ) : (
//           <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//             <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
//           </svg>
//         )}
//       </button>
//     </div>

//     {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
//     {showProfile && <ProFile1 onClose={() => setShowProFile(false)} datax={friend} />}
//   </div>
// );
// }

// export default Chat;
//Xin nhat 


import classNames from "classnames/bind";
import styles from "./Chat.module.scss";
import { useState, useEffect, useRef, useCallback } from "react";
import ProFile1 from "~/pages/ProFile1";
import ChatPreview from "./ChatPreview";
import FriendRequestBar from "./FriendRequestBar";
import FriendRequestConfirmationBar from "./FriendRequestConfirmationBar";
import ChatHeader from "./ChatHeader";
import axios from "axios";
import { io } from "socket.io-client";

const cx = classNames.bind(styles);

function Chat({ friend, onToggleDetail }) {
  const [open, setOpen] = useState(false);
  const [text, setText] = useState("");
  const [showProfile, setShowProFile] = useState(false);
  const [previewImage, setPreviewImage] = useState(null);
  const messagesContainerRef = useRef(null);
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showSendRequestBar, setShowSendRequestBar] = useState(false);
  const socketRef = useRef(null);

  // H√†m cu·ªôn xu·ªëng cu·ªëi
  const scrollToBottom = useCallback(() => {
    if (messagesContainerRef.current) {
      messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
    }
  }, []);

  // Cu·ªôn xu·ªëng cu·ªëi khi messages thay ƒë·ªïi
  useEffect(() => {
    scrollToBottom();
  }, [messages, scrollToBottom]);

  // K·∫øt n·ªëi WebSocket khi friend thay ƒë·ªïi
  useEffect(() => {
    if (friend?.sender) {
      socketRef.current = io("http://localhost:5000", {
        query: { userId: friend.sender },
      });

      socketRef.current.on("receiveMessage", (data) => {
        const receivedMessage = {
          id: data.message.id || new Date().getTime() + Math.random(),
          text: data.message.message_type === "text" && typeof data.message.content === "string" ? data.message.content : "",
          type: data.message.sender === friend.sender ? "sent" : "received",
          timestamp: new Date(data.message.timestamp),
          temporaryImage: data.message.message_type === "image" && data.message.base64Data ? data.message.base64Data : null,
          image: data.message.message_type === "image" && data.message.url ? `http://localhost:5000${data.message.url}` : null,
          temporaryVideo: data.message.message_type === "video" && data.message.base64Data ? data.message.base64Data : null,
          video: data.message.message_type === "video" && data.message.url ? `http://localhost:5000${data.message.url}` : null,
          file: data.message.message_type === "file" ? { name: data.message.content, url: `http://localhost:5000${data.message.url}` } : null,
          isTemporary: !!data.message.base64Data,
        };

        setMessages((prev) => {
          // Ki·ªÉm tra n·∫øu tin nh·∫Øn ƒë√£ t·ªìn t·∫°i (d·ª±a tr√™n id)
          const existingMessageIndex = prev.findIndex((msg) => msg.id === receivedMessage.id);
          if (existingMessageIndex !== -1) {
            // C·∫≠p nh·∫≠t tin nh·∫Øn hi·ªán c√≥
            const updatedMessages = [...prev];
            updatedMessages[existingMessageIndex] = {
              ...updatedMessages[existingMessageIndex],
              temporaryImage: receivedMessage.temporaryImage || updatedMessages[existingMessageIndex].temporaryImage,
              image: receivedMessage.image || updatedMessages[existingMessageIndex].image,
              temporaryVideo: receivedMessage.temporaryVideo || updatedMessages[existingMessageIndex].temporaryVideo,
              video: receivedMessage.video || updatedMessages[existingMessageIndex].video,
              isTemporary: false,
            };
            return updatedMessages;
          }
          // Th√™m tin nh·∫Øn m·ªõi
          return [...prev, receivedMessage];
        });
        scrollToBottom();
      });

      socketRef.current.on("updateMessage", (data) => {
        setMessages((prev) =>
          prev.map((msg) => {
            if (msg.id === data.message.id) {
              return {
                ...msg,
                image: data.message.url && data.message.message_type === "image" ? `http://localhost:5000${data.message.url}` : msg.image,
                video: data.message.url && data.message.message_type === "video" ? `http://localhost:5000${data.message.url}` : msg.video,
                isTemporary: false,
                // Gi·ªØ nguy√™n temporaryImage v√† temporaryVideo ƒë·ªÉ ti·∫øp t·ª•c d√πng base64
              };
            }
            return msg;
          })
        );
        scrollToBottom();
      });

      return () => {
        if (socketRef.current) {
          socketRef.current.disconnect();
        }
      };
    }
  }, [friend, scrollToBottom]);

  // Fetch tin nh·∫Øn t·ª´ API
  useEffect(() => {
    const fetchMessages = async () => {
      if (!friend || !friend.id) {
        setMessages([]);
        setLoading(false);
        return;
      }

      try {
        const response = await axios.post("http://localhost:5000/api/chat/messages/", {
          friendId: friend.id,
        });

        if (response.status === 200 && Array.isArray(response.data)) {
          const transformedMessages = response.data
            .map((msg) => ({
              id: msg.id,
              text: msg.message_type === "text" && typeof msg.content === "string" ? msg.content : "",
              type: msg.sender === friend.sender ? "sent" : "received",
              timestamp: new Date(msg.timestamp),
              image: msg.message_type === "image" ? `http://localhost:5000${msg.url}` : null,
              video: msg.message_type === "video" ? `http://localhost:5000${msg.url}` : null,
              file: msg.message_type === "file" ? { name: msg.content, url: `http://localhost:5000${msg.url}` } : null,
              isTemporary: false,
            }))
            .filter((msg) => msg.text || msg.image || msg.video || msg.file);

          setMessages(transformedMessages);
        } else {
          setError("D·ªØ li·ªáu tin nh·∫Øn kh√¥ng h·ª£p l·ªá.");
        }
      } catch (err) {
        setError("L·ªói khi t·∫£i tin nh·∫Øn: " + err.message);
        console.error("L·ªói khi l·∫•y tin nh·∫Øn:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchMessages();
  }, [friend]);

  const toggleRequestBar = useCallback(() => {
    setShowSendRequestBar((prev) => !prev);
  }, []);

  const emojis = ["üòÄ", "üòÇ", "üòç", "üòä", "üòé", "ü§î", "üëç", "‚ù§Ô∏è", "üéâ", "üî•", "üíØ", "‚ú®"];

  const handleEmoji = useCallback((emoji) => {
    setText((prev) => prev + emoji);
    setOpen(false);
  }, []);

  const handleSend = useCallback(async () => {
    if (text.trim()) {
      const newMessage = {
        id: Date.now(),
        text: text.trim(),
        type: "sent",
        timestamp: new Date(),
        isTemporary: false,
      };
      setMessages((prev) => [...prev, newMessage]);
      setText("");

      if (socketRef.current) {
        socketRef.current.emit("sendMessage", {
          toUserId: friend.member,
          message: {
            id: newMessage.id,
            conversation_id: friend.id,
            sender: friend.sender,
            recipient: friend.member,
            content: newMessage.text,
            message_type: "text",
            timestamp: new Date().toISOString(),
            url: null,
          },
        });
      }

      try {
        await axios.post("http://localhost:5000/api/chat/send-message/", {
          id: newMessage.id,
          conversationId: friend.id,
          sender: friend.sender,
          content: text.trim(),
          message_type: "text",
          timestamp: new Date().toISOString(),
          recipient: friend.member,
        });
      } catch (error) {
        console.error("L·ªói g·ª≠i tin nh·∫Øn:", error);
      }
    } else {
      const likeMessage = {
        id: Date.now(),
        text: "üëç",
        type: "sent",
        timestamp: new Date(),
        isTemporary: false,
      };
      setMessages((prev) => [...prev, likeMessage]);

      if (socketRef.current) {
        socketRef.current.emit("sendMessage", {
          toUserId: friend.member,
          message: {
            id: likeMessage.id,
            conversation_id: friend.id,
            sender: friend.sender,
            recipient: friend.member,
            content: "üëç",
            message_type: "text",
            timestamp: new Date().toISOString(),
            url: null,
          },
        });
      }

      try {
        await axios.post("http://localhost:5000/api/chat/send-message/", {
          id: likeMessage.id,
          conversationId: friend.id,
          sender: friend.sender,
          content: "üëç",
          message_type: "text",
          timestamp: new Date().toISOString(),
          recipient: friend.member,
        });
      } catch (error) {
        console.error("L·ªói g·ª≠i tin nh·∫Øn like:", error);
      }
    }
  }, [text, friend]);

  const handleKeyPress = useCallback((e) => {
    if (e.key === "Enter") {
      handleSend();
    }
  }, [handleSend]);

  const handleAvatarClick = useCallback(() => {
    setShowProFile(true);
  }, []);

  const handleMediaSelect = useCallback(async (e, mediaType) => {
    const file = e.target.files[0];
    if (!file) {
      alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp.");
      return;
    }

    if (file.size > 50 * 1024 * 1024) {
      alert("T·ªáp qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 50MB.");
      return;
    }

    if (mediaType === "image" && !file.type.startsWith("image/")) {
      alert("Vui l√≤ng ch·ªçn t·ªáp h√¨nh ·∫£nh.");
      return;
    }

    if (mediaType === "video" && !file.type.startsWith("video/")) {
      alert("Vui l√≤ng ch·ªçn t·ªáp video.");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const tempMessageId = Date.now() + Math.random();
      const tempMessage = {
        id: tempMessageId,
        type: "sent",
        timestamp: new Date(),
        uploading: true,
        fileName: file.name,
        isTemporary: true,
      };

      let base64Data = null;
      if (mediaType === "image") {
        tempMessage.temporaryImage = reader.result; // L∆∞u base64 v√†o temporaryImage
        base64Data = reader.result;
      } else if (mediaType === "video") {
        tempMessage.temporaryVideo = reader.result; // L∆∞u base64 v√†o temporaryVideo
        base64Data = reader.result;
      } else if (mediaType === "file") {
        tempMessage.file = {
          name: file.name,
          url: reader.result,
        };
      }

      setMessages((prev) => [...prev, tempMessage]);
      scrollToBottom();

      if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
        socketRef.current.emit("sendMessage", {
          toUserId: friend.member,
          message: {
            id: tempMessageId,
            conversation_id: friend.id,
            sender: friend.sender,
            recipient: friend.member,
            content: file.name,
            message_type: mediaType,
            timestamp: new Date().toISOString(),
            url: null,
            base64Data: base64Data,
          },
        });
      }

      uploadFileToServer(file, mediaType, tempMessageId, base64Data);
    };

    reader.onerror = () => {
      alert("L·ªói khi ƒë·ªçc t·ªáp.");
    };
    reader.readAsDataURL(file);
  }, [friend, scrollToBottom]);

  const uploadFileToServer = async (file, mediaType, messageId, base64Data = null) => {
    const formData = new FormData();
    let endpoint;

    if (mediaType === "image") {
      formData.append("file", file, encodeURIComponent(file.name));
      endpoint = "/upload-file";
    } else if (mediaType === "video") {
      formData.append("video", file, encodeURIComponent(file.name));
      endpoint = "/upload-video";
    } else if (mediaType === "file") {
      formData.append("file", file, encodeURIComponent(file.name));
      endpoint = "/upload-file";
    }

    try {
      const uploadResponse = await axios.post(`http://localhost:5000${endpoint}`, formData, {
        headers: {
          "Content-Type": "multipart/form-data",
          "Accept": "application/json",
        },
      });

      if (uploadResponse.data.url) {
        const filePath = uploadResponse.data.url.replace("http://localhost:5000", "");
        const fullUrl = uploadResponse.data.url;

        // C·∫≠p nh·∫≠t tin nh·∫Øn v·ªõi URL, gi·ªØ nguy√™n temporaryImage/temporaryVideo
        setMessages((prev) =>
          prev.map((msg) => {
            if (msg.id === messageId) {
              const updatedMsg = {
                ...msg,
                uploading: false,
                isTemporary: false,
                image: mediaType === "image" ? fullUrl : msg.image,
                video: mediaType === "video" ? fullUrl : msg.video,
                file: mediaType === "file" ? { name: decodeURIComponent(file.name), url: fullUrl } : msg.file,
                // Kh√¥ng x√≥a temporaryImage/temporaryVideo ƒë·ªÉ gi·ªØ base64
              };
              return updatedMsg;
            }
            return msg;
          })
        );

        if (socketRef.current && (mediaType === "image" || mediaType === "video")) {
          socketRef.current.emit("updateMessage", {
            toUserId: friend.member,
            message: {
              id: messageId,
              conversation_id: friend.id,
              message_type: mediaType,
              url: filePath,
            },
          });
        }

        try {
          await axios.post("http://localhost:5000/api/chat/send-message/", {
            id: messageId,
            conversationId: friend.id,
            sender: friend.sender,
            content: decodeURIComponent(file.name),
            message_type: mediaType,
            timestamp: new Date().toISOString(),
            recipient: friend.member,
            url: filePath,
          });
        } catch (messageError) {
          console.error("L·ªói g·ª≠i tin nh·∫Øn:", messageError);
        }
      }
    } catch (uploadError) {
      setMessages((prev) =>
        prev.map((msg) => {
          if (msg.id === messageId) {
            return {
              ...msg,
              uploading: false,
              error: true,
              isTemporary: false,
            };
          }
          return msg;
        })
      );
      alert("Upload th·∫•t b·∫°i: " + (uploadError.response?.data?.error || uploadError.message));
    }
  };

  const handleSendFriendRequest = useCallback((friendId, friendName) => {
    console.log(`G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ID ${friendId}: ${friendName}`);
  }, []);

  const handleConfirmFriendRequest = useCallback((friendId, friendName) => {
    console.log(`X√°c nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
  }, []);

  const handleRejectFriendRequest = useCallback((friendId, friendName) => {
    console.log(`T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ID ${friendId}: ${friendName}`);
  }, []);

  const handleClosePreview = useCallback(() => {
    setPreviewImage(null);
  }, []);

  const isValidUrl = (url) => {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  };

  const renderMessageContent = (message) => {
    if (message.uploading) {
      return (
        <div className={cx("message-uploading")}>
          <span>ƒêang t·∫£i {message.fileName}...</span>
        </div>
      );
    }

    if (message.error) {
      return (
        <div className={cx("message-error")}>
          <span>L·ªói t·∫£i {message.fileName}</span>
        </div>
      );
    }

    // Hi·ªÉn th·ªã ·∫£nh: ∆Øu ti√™n temporaryImage (base64) n·∫øu c√≥
    if (message.temporaryImage || message.image) {
      const imageSource = message.temporaryImage || message.image;
      const isBase64 = imageSource && imageSource.startsWith("data:image/");

      return (
        <div
          className={cx("message-image", { temporary: message.isTemporary })}
          onClick={() => setPreviewImage(imageSource)}
          aria-label="Xem tr∆∞·ªõc h√¨nh ·∫£nh"
        >
          <img
            src={
              isBase64
                ? imageSource
                : imageSource && imageSource.startsWith("http")
                ? imageSource
                : `http://localhost:5000${imageSource}`
            }
            alt={message.fileName || "H√¨nh ·∫£nh ƒë∆∞·ª£c chia s·∫ª"}
            className={cx("image-content")}
            onError={(e) => {
              console.error("L·ªói t·∫£i:", e.target.src);
              e.target.parentElement.style.display = "none";
            }}
          />
          {message.uploading && (
            <div className={cx("uploading-indicator")}>
              ƒêang t·∫£i...
            </div>
          )}
        </div>
      );
    }

    // Hi·ªÉn th·ªã video: ∆Øu ti√™n temporaryVideo (base64) n·∫øu c√≥
    if (message.temporaryVideo || message.video) {
      const videoSource = message.temporaryVideo || message.video;
      const isBase64 = videoSource && videoSource.startsWith("data:video/");

      return (
        <div className={cx("message-video", { temporary: message.isTemporary })}>
          <video controls className={cx("video-content")}>
            <source
              src={
                isBase64
                  ? videoSource
                  : videoSource && videoSource.startsWith("http")
                  ? videoSource
                  : `http://localhost:5000${videoSource}`
              }
              type="video/mp4"
            />
            Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
          </video>
          {message.uploading && (
            <div className={cx("uploading-indicator")}>
              ƒêang t·∫£i...
            </div>
          )}
        </div>
      );
    }

    if (message.file) {
      return (
        <div className={cx("message-file")}>
          <a
            href={
              message.file.url.startsWith("http")
                ? message.file.url
                : `http://localhost:5000${message.file.url}`
            }
            download={message.file.name}
          >
            {message.file.name}
          </a>
        </div>
      );
    }

    if (typeof message.text === "string" && message.text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const parts = message.text.split(urlRegex);
      return (
        <span>
          {parts.map((part, index) => {
            if (part.match(urlRegex) && isValidUrl(part)) {
              return (
                <a
                  key={index}
                  href={part}
                  target="_blank"
                  rel="noopener noreferrer"
                  className={cx("message-link")}
                >
                  {part}
                </a>
              );
            }
            return part;
          })}
        </span>
      );
    }
    return <span>{message.text || ""}</span>;
  };

  const formatTime = (dateObj) => {
    return dateObj.toLocaleTimeString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
  };

  const formatSeparator = (dateObj) => {
    return (
      dateObj.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) +
      " " +
      formatTime(dateObj)
    );
  };

  if (!friend) {
    return (
      <div className={cx("chat")}>
        <div className={cx("empty-state")}>
          <div className={cx("empty-content")}>
            <div className={cx("empty-icon")}>
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                <path
                  d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
                  fill="currentColor"
                  opacity="0.3"
                />
                <circle cx="8" cy="12" r="1" fill="currentColor" />
                <circle cx="12" cy="12" r="1" fill="currentColor" />
                <circle cx="16" cy="12" r="1" fill="currentColor" />
              </svg>
            </div>
            <div className={cx("empty-text")}>
              <h2>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h2>
              <p>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={cx("chat")}>
      <ChatHeader friend={friend} onAvatarClick={handleAvatarClick} onToggleDetail={onToggleDetail} />

      {showSendRequestBar ? (
        <FriendRequestBar friend={friend} onSendRequest={handleSendFriendRequest} isVisible={false} />
      ) : (
        <FriendRequestConfirmationBar
          friend={friend}
          onConfirmRequest={handleConfirmFriendRequest}
          onRejectRequest={handleRejectFriendRequest}
          isVisible={false}
        />
      )}

      <div className={cx("center")} ref={messagesContainerRef}>
        {loading ? (
          <div>ƒêang t·∫£i...</div>
        ) : error ? (
          <div className={cx("error")}>{error}</div>
        ) : (
          messages.map((message, index) => {
            const prevMsg = messages[index - 1];
            const nextMsg = messages[index + 1];
            const currentTime = message.timestamp;

            let showSeparator = false;
            let showTime = false;

            if (!prevMsg) {
              showSeparator = true;
            } else {
              const diffMinutes = (currentTime - prevMsg.timestamp) / 1000 / 60;
              if (diffMinutes >= 10) {
                showSeparator = true;
              }
            }

            if (!nextMsg) {
              showTime = true;
            } else {
              const sameMinute =
                currentTime.getHours() === nextMsg.timestamp.getHours() &&
                currentTime.getMinutes() === nextMsg.timestamp.getMinutes();
              if (!sameMinute) {
                showTime = true;
              }
            }

            return (
              <div key={message.id} className={cx("message-wrapper", message.type)}>
                {showSeparator && (
                  <div className={cx("time-separator")}>
                    <div className={cx("time-separator-content")}>
                      {formatSeparator(message.timestamp)}
                    </div>
                  </div>
                )}
                <div className={cx("message", message.type)}>
                  <div
                    className={cx("message-bubble", {
                      "has-media": message.temporaryImage || message.image || message.temporaryVideo || message.video || message.file,
                      temporary: message.isTemporary,
                    })}
                  >
                    {renderMessageContent(message)}
                  </div>
                  {showTime && (
                    <div className={cx("message-time")}>{formatTime(message.timestamp)}</div>
                  )}
                </div>
              </div>
            );
          })
        )}
      </div>

      {previewImage && <ChatPreview imageUrl={previewImage} onClose={handleClosePreview} />}

      <div className={cx("cr")}>
        <label className={cx("cr-button")} title="Ch·ªçn ·∫£nh" aria-label="Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i">
          <input
            type="file"
            accept="image/*"
            style={{ display: "none" }}
            onChange={(e) => handleMediaSelect(e, "image")}
          />
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
          </svg>
        </label>
        <label className={cx("cr-button")} title="Ch·ªçn t·ªáp" aria-label="Ch·ªçn t·ªáp ƒë·ªÉ g·ª≠i">
          <input
            type="file"
            accept=".pdf,.doc,.docx,.txt"
            style={{ display: "none" }}
            onChange={(e) => handleMediaSelect(e, "file")}
          />
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" />
          </svg>
        </label>
        <label className={cx("cr-button")} title="Ch·ªçn video" aria-label="Ch·ªçn video ƒë·ªÉ g·ª≠i">
          <input
            type="file"
            accept="video/*"
            style={{ display: "none" }}
            onChange={(e) => handleMediaSelect(e, "video")}
          />
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
          </svg>
        </label>
      </div>

      <div className={cx("input-area")}>
        <input
          type="text"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          value={text}
          onChange={(e) => setText(e.target.value)}
          onKeyPress={handleKeyPress}
          className={cx("message-input")}
          aria-label="Nh·∫≠p tin nh·∫Øn"
        />
        <div className={cx("emoji-container")}>
          <button
            className={cx("emoji-button")}
            onClick={() => setOpen((prev) => !prev)}
            aria-label="M·ªü b·∫£ng ch·ªçn bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c"
          >
            üòä
          </button>
          <div className={cx("emoji-picker")} style={{ display: open ? "block" : "none" }}>
            {emojis.map((emoji, index) => (
              <button
                key={index}
                onClick={() => handleEmoji(emoji)}
                className={cx("emoji-item")}
                aria-label={`Ch·ªçn bi·ªÉu t∆∞·ª£ng ${emoji}`}
              >
                {emoji}
              </button>
            ))}
          </div>
        </div>
        <button
          onClick={handleSend}
          className={cx("send-button", { active: text.trim() })}
          aria-label={text.trim() ? "G·ª≠i tin nh·∫Øn" : "G·ª≠i like"}
        >
          {text.trim() ? (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          ) : (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" />
            </svg>
          )}
        </button>
      </div>

      {open && <div className={cx("overlay")} onClick={() => setOpen(false)} />}
      {showProfile && <ProFile1 onClose={() => setShowProFile(false)} datax={friend} />}
    </div>
  );
}

export default Chat;

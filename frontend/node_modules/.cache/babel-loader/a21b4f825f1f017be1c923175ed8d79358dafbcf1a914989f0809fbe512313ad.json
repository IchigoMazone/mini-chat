{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect, useCallback } from \"react\";\nimport axios from \"axios\";\nfunction useMessagesHandler(friend) {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [error, setError] = useState(null);\n  const fetchMessages = useCallback(async (before = null) => {\n    if (!friend || !friend.id || !friend.sender) {\n      setMessages([]);\n      setLoading(false);\n      setHasMore(false);\n      return;\n    }\n    try {\n      const payload = {\n        friendId: friend.id,\n        limit: 30\n      };\n      if (before) {\n        payload.before = before;\n      }\n      console.log('[FetchMessages] Sending payload:', payload); // Log payload\n      const response = await axios.post(\"http://localhost:5000/api/chat/messages/\", payload);\n      console.log('[FetchMessages] Raw response:', response); // Log toàn bộ response\n      console.log('[FetchMessages] Response data:', response.data.data); // Log data\n\n      if (response.status === 200) {\n        console.log(\"API cua message hien thi\", response.data);\n        const transformedMessages = response.data.data.map(msg => ({\n          id: msg._id,\n          text: msg.message_type === \"text\" && typeof msg.content === \"string\" ? msg.content : \"\",\n          type: msg.sender === friend.sender ? \"sent\" : \"received\",\n          timestamp: new Date(msg.timestamp),\n          image: msg.message_type === \"image\" ? msg.url : null,\n          video: msg.message_type === \"video\" ? msg.url : null,\n          file: msg.message_type === \"file\" ? {\n            name: msg.content,\n            url: msg.url\n          } : null,\n          isTemporary: false\n        })).filter(msg => msg.text || msg.image || msg.video || msg.file);\n        setMessages(prev => {\n          if (before) {\n            return [...transformedMessages, ...prev].filter((msg, index, self) => index === self.findIndex(m => m.id === msg.id));\n          } else {\n            localStorage.removeItem('lastMessageId');\n            return transformedMessages;\n          }\n        });\n        setHasMore(transformedMessages.length === 50);\n      } else {\n        setError(\"Dữ liệu tin nhắn không hợp lệ.\");\n        setHasMore(false);\n      }\n    } catch (err) {\n      setError(\"Lỗi khi tải tin nhắn: \" + err.message);\n      console.error(\"Lỗi khi lấy tin nhắn:\", err);\n      setHasMore(false);\n    } finally {\n      setLoading(false);\n      setIsLoadingMore(false);\n    }\n  }, [friend]);\n  const loadMoreMessages = useCallback(() => {\n    if (messages.length === 0) return;\n    setIsLoadingMore(true);\n    const firstMessage = messages[0];\n    const before = firstMessage.timestamp.toISOString();\n    fetchMessages(before);\n  }, [messages, fetchMessages]);\n  useEffect(() => {\n    setLoading(true);\n    setIsLoadingMore(false);\n    setHasMore(true);\n    setError(null);\n    setMessages([]);\n    fetchMessages(null);\n  }, [friend, fetchMessages]);\n  return {\n    messages,\n    setMessages,\n    loading,\n    isLoadingMore,\n    hasMore,\n    error,\n    loadMoreMessages,\n    fetchMessages\n  };\n}\n_s(useMessagesHandler, \"Zv4YFgg9JI+KfzgynuZN8OgP350=\");\nexport default useMessagesHandler;","map":{"version":3,"names":["useState","useEffect","useCallback","axios","useMessagesHandler","friend","_s","messages","setMessages","loading","setLoading","isLoadingMore","setIsLoadingMore","hasMore","setHasMore","error","setError","fetchMessages","before","id","sender","payload","friendId","limit","console","log","response","post","data","status","transformedMessages","map","msg","_id","text","message_type","content","type","timestamp","Date","image","url","video","file","name","isTemporary","filter","prev","index","self","findIndex","m","localStorage","removeItem","length","err","message","loadMoreMessages","firstMessage","toISOString"],"sources":["/home/ichigomazone/Vscode/ReactJs/new-ui./frontend/src/components/Chat/MessageHandler/useMessageHandler.js"],"sourcesContent":["import { useState, useEffect, useCallback } from \"react\";\nimport axios from \"axios\";\n\nfunction useMessagesHandler(friend) {\n  const [messages, setMessages] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [error, setError] = useState(null);\n\n  const fetchMessages = useCallback(async (before = null) => {\n    if (!friend || !friend.id || !friend.sender) {\n      setMessages([]);\n      setLoading(false);\n      setHasMore(false);\n      return;\n    }\n\n    try {\n      const payload = {\n        friendId: friend.id,\n        limit: 30,\n      };\n      if (before) {\n        payload.before = before;\n      }\n      \n      console.log('[FetchMessages] Sending payload:', payload); // Log payload\n      const response = await axios.post(\"http://localhost:5000/api/chat/messages/\", payload);\n      console.log('[FetchMessages] Raw response:', response); // Log toàn bộ response\n      console.log('[FetchMessages] Response data:', response.data.data); // Log data\n\n      if (response.status === 200) {\n        console.log(\"API cua message hien thi\", response.data)\n        const transformedMessages = response.data.data\n          .map((msg) => ({\n            id: msg._id,\n            text: msg.message_type === \"text\" && typeof msg.content === \"string\" ? msg.content : \"\",\n            type: msg.sender === friend.sender ? \"sent\" : \"received\",\n            timestamp: new Date(msg.timestamp),\n            image: msg.message_type === \"image\" ? msg.url : null,\n            video: msg.message_type === \"video\" ? msg.url : null,\n            file: msg.message_type === \"file\" ? { name: msg.content, url: msg.url } : null,\n            isTemporary: false,\n          }))\n          .filter((msg) => msg.text || msg.image || msg.video || msg.file);\n\n        setMessages((prev) => {\n          if (before) {\n            return [...transformedMessages, ...prev].filter((msg, index, self) =>\n              index === self.findIndex((m) => m.id === msg.id)\n            );\n          } else {\n            localStorage.removeItem('lastMessageId');\n            return transformedMessages;\n          }\n        });\n\n        setHasMore(transformedMessages.length === 50);\n      } else {\n        setError(\"Dữ liệu tin nhắn không hợp lệ.\");\n        setHasMore(false);\n      }\n    } catch (err) {\n      setError(\"Lỗi khi tải tin nhắn: \" + err.message);\n      console.error(\"Lỗi khi lấy tin nhắn:\", err);\n      setHasMore(false);\n    } finally {\n      setLoading(false);\n      setIsLoadingMore(false);\n    }\n  }, [friend]);\n\n  const loadMoreMessages = useCallback(() => {\n    if (messages.length === 0) return;\n    setIsLoadingMore(true);\n    const firstMessage = messages[0];\n    const before = firstMessage.timestamp.toISOString();\n    fetchMessages(before);\n  }, [messages, fetchMessages]);\n\n  useEffect(() => {\n    setLoading(true);\n    setIsLoadingMore(false);\n    setHasMore(true);\n    setError(null);\n    setMessages([]);\n    fetchMessages(null);\n  }, [friend, fetchMessages]);\n\n  return {\n    messages,\n    setMessages,\n    loading,\n    isLoadingMore,\n    hasMore,\n    error,\n    loadMoreMessages,\n    fetchMessages\n  };\n}\n\nexport default useMessagesHandler;"],"mappings":";AAAA,SAASA,QAAQ,EAAEC,SAAS,EAAEC,WAAW,QAAQ,OAAO;AACxD,OAAOC,KAAK,MAAM,OAAO;AAEzB,SAASC,kBAAkBA,CAACC,MAAM,EAAE;EAAAC,EAAA;EAClC,MAAM,CAACC,QAAQ,EAAEC,WAAW,CAAC,GAAGR,QAAQ,CAAC,EAAE,CAAC;EAC5C,MAAM,CAACS,OAAO,EAAEC,UAAU,CAAC,GAAGV,QAAQ,CAAC,IAAI,CAAC;EAC5C,MAAM,CAACW,aAAa,EAAEC,gBAAgB,CAAC,GAAGZ,QAAQ,CAAC,KAAK,CAAC;EACzD,MAAM,CAACa,OAAO,EAAEC,UAAU,CAAC,GAAGd,QAAQ,CAAC,IAAI,CAAC;EAC5C,MAAM,CAACe,KAAK,EAAEC,QAAQ,CAAC,GAAGhB,QAAQ,CAAC,IAAI,CAAC;EAExC,MAAMiB,aAAa,GAAGf,WAAW,CAAC,OAAOgB,MAAM,GAAG,IAAI,KAAK;IACzD,IAAI,CAACb,MAAM,IAAI,CAACA,MAAM,CAACc,EAAE,IAAI,CAACd,MAAM,CAACe,MAAM,EAAE;MAC3CZ,WAAW,CAAC,EAAE,CAAC;MACfE,UAAU,CAAC,KAAK,CAAC;MACjBI,UAAU,CAAC,KAAK,CAAC;MACjB;IACF;IAEA,IAAI;MACF,MAAMO,OAAO,GAAG;QACdC,QAAQ,EAAEjB,MAAM,CAACc,EAAE;QACnBI,KAAK,EAAE;MACT,CAAC;MACD,IAAIL,MAAM,EAAE;QACVG,OAAO,CAACH,MAAM,GAAGA,MAAM;MACzB;MAEAM,OAAO,CAACC,GAAG,CAAC,kCAAkC,EAAEJ,OAAO,CAAC,CAAC,CAAC;MAC1D,MAAMK,QAAQ,GAAG,MAAMvB,KAAK,CAACwB,IAAI,CAAC,0CAA0C,EAAEN,OAAO,CAAC;MACtFG,OAAO,CAACC,GAAG,CAAC,+BAA+B,EAAEC,QAAQ,CAAC,CAAC,CAAC;MACxDF,OAAO,CAACC,GAAG,CAAC,gCAAgC,EAAEC,QAAQ,CAACE,IAAI,CAACA,IAAI,CAAC,CAAC,CAAC;;MAEnE,IAAIF,QAAQ,CAACG,MAAM,KAAK,GAAG,EAAE;QAC3BL,OAAO,CAACC,GAAG,CAAC,0BAA0B,EAAEC,QAAQ,CAACE,IAAI,CAAC;QACtD,MAAME,mBAAmB,GAAGJ,QAAQ,CAACE,IAAI,CAACA,IAAI,CAC3CG,GAAG,CAAEC,GAAG,KAAM;UACbb,EAAE,EAAEa,GAAG,CAACC,GAAG;UACXC,IAAI,EAAEF,GAAG,CAACG,YAAY,KAAK,MAAM,IAAI,OAAOH,GAAG,CAACI,OAAO,KAAK,QAAQ,GAAGJ,GAAG,CAACI,OAAO,GAAG,EAAE;UACvFC,IAAI,EAAEL,GAAG,CAACZ,MAAM,KAAKf,MAAM,CAACe,MAAM,GAAG,MAAM,GAAG,UAAU;UACxDkB,SAAS,EAAE,IAAIC,IAAI,CAACP,GAAG,CAACM,SAAS,CAAC;UAClCE,KAAK,EAAER,GAAG,CAACG,YAAY,KAAK,OAAO,GAAGH,GAAG,CAACS,GAAG,GAAG,IAAI;UACpDC,KAAK,EAAEV,GAAG,CAACG,YAAY,KAAK,OAAO,GAAGH,GAAG,CAACS,GAAG,GAAG,IAAI;UACpDE,IAAI,EAAEX,GAAG,CAACG,YAAY,KAAK,MAAM,GAAG;YAAES,IAAI,EAAEZ,GAAG,CAACI,OAAO;YAAEK,GAAG,EAAET,GAAG,CAACS;UAAI,CAAC,GAAG,IAAI;UAC9EI,WAAW,EAAE;QACf,CAAC,CAAC,CAAC,CACFC,MAAM,CAAEd,GAAG,IAAKA,GAAG,CAACE,IAAI,IAAIF,GAAG,CAACQ,KAAK,IAAIR,GAAG,CAACU,KAAK,IAAIV,GAAG,CAACW,IAAI,CAAC;QAElEnC,WAAW,CAAEuC,IAAI,IAAK;UACpB,IAAI7B,MAAM,EAAE;YACV,OAAO,CAAC,GAAGY,mBAAmB,EAAE,GAAGiB,IAAI,CAAC,CAACD,MAAM,CAAC,CAACd,GAAG,EAAEgB,KAAK,EAAEC,IAAI,KAC/DD,KAAK,KAAKC,IAAI,CAACC,SAAS,CAAEC,CAAC,IAAKA,CAAC,CAAChC,EAAE,KAAKa,GAAG,CAACb,EAAE,CACjD,CAAC;UACH,CAAC,MAAM;YACLiC,YAAY,CAACC,UAAU,CAAC,eAAe,CAAC;YACxC,OAAOvB,mBAAmB;UAC5B;QACF,CAAC,CAAC;QAEFhB,UAAU,CAACgB,mBAAmB,CAACwB,MAAM,KAAK,EAAE,CAAC;MAC/C,CAAC,MAAM;QACLtC,QAAQ,CAAC,gCAAgC,CAAC;QAC1CF,UAAU,CAAC,KAAK,CAAC;MACnB;IACF,CAAC,CAAC,OAAOyC,GAAG,EAAE;MACZvC,QAAQ,CAAC,wBAAwB,GAAGuC,GAAG,CAACC,OAAO,CAAC;MAChDhC,OAAO,CAACT,KAAK,CAAC,uBAAuB,EAAEwC,GAAG,CAAC;MAC3CzC,UAAU,CAAC,KAAK,CAAC;IACnB,CAAC,SAAS;MACRJ,UAAU,CAAC,KAAK,CAAC;MACjBE,gBAAgB,CAAC,KAAK,CAAC;IACzB;EACF,CAAC,EAAE,CAACP,MAAM,CAAC,CAAC;EAEZ,MAAMoD,gBAAgB,GAAGvD,WAAW,CAAC,MAAM;IACzC,IAAIK,QAAQ,CAAC+C,MAAM,KAAK,CAAC,EAAE;IAC3B1C,gBAAgB,CAAC,IAAI,CAAC;IACtB,MAAM8C,YAAY,GAAGnD,QAAQ,CAAC,CAAC,CAAC;IAChC,MAAMW,MAAM,GAAGwC,YAAY,CAACpB,SAAS,CAACqB,WAAW,CAAC,CAAC;IACnD1C,aAAa,CAACC,MAAM,CAAC;EACvB,CAAC,EAAE,CAACX,QAAQ,EAAEU,aAAa,CAAC,CAAC;EAE7BhB,SAAS,CAAC,MAAM;IACdS,UAAU,CAAC,IAAI,CAAC;IAChBE,gBAAgB,CAAC,KAAK,CAAC;IACvBE,UAAU,CAAC,IAAI,CAAC;IAChBE,QAAQ,CAAC,IAAI,CAAC;IACdR,WAAW,CAAC,EAAE,CAAC;IACfS,aAAa,CAAC,IAAI,CAAC;EACrB,CAAC,EAAE,CAACZ,MAAM,EAAEY,aAAa,CAAC,CAAC;EAE3B,OAAO;IACLV,QAAQ;IACRC,WAAW;IACXC,OAAO;IACPE,aAAa;IACbE,OAAO;IACPE,KAAK;IACL0C,gBAAgB;IAChBxC;EACF,CAAC;AACH;AAACX,EAAA,CAjGQF,kBAAkB;AAmG3B,eAAeA,kBAAkB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
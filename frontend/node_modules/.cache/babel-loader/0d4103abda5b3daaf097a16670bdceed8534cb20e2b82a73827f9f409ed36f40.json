{"ast":null,"code":"import{useState,useEffect,useCallback}from\"react\";import axios from\"axios\";function useMessagesHandler(friend){const[messages,setMessages]=useState([]);const[loading,setLoading]=useState(true);const[isLoadingMore,setIsLoadingMore]=useState(false);const[hasMore,setHasMore]=useState(true);const[error,setError]=useState(null);const fetchMessages=useCallback(async function(){let before=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!friend||!friend.id||!friend.sender){setMessages([]);setLoading(false);setHasMore(false);return;}try{const payload={friendId:friend.id,limit:30};if(before){payload.before=before;}console.log('[FetchMessages] Sending payload:',payload);// Log payload\nconst response=await axios.post(\"http://localhost:5000/api/chat/messages/\",payload);console.log('[FetchMessages] Raw response:',response);// Log toàn bộ response\nconsole.log('[FetchMessages] Response data:',response.data.data);// Log data\nif(response.status===200){console.log(\"API cua message hien thi\",response.data);const transformedMessages=response.data.data.map(msg=>({id:msg._id,text:msg.message_type===\"text\"&&typeof msg.content===\"string\"?msg.content:\"\",type:msg.sender===friend.sender?\"sent\":\"received\",timestamp:new Date(msg.timestamp),image:msg.message_type===\"image\"?msg.url:null,video:msg.message_type===\"video\"?msg.url:null,file:msg.message_type===\"file\"?{name:msg.content,url:msg.url}:null,isTemporary:false})).filter(msg=>msg.text||msg.image||msg.video||msg.file);setMessages(prev=>{if(before){return[...transformedMessages,...prev].filter((msg,index,self)=>index===self.findIndex(m=>m.id===msg.id));}else{localStorage.removeItem('lastMessageId');return transformedMessages;}});setHasMore(transformedMessages.length===50);}else{setError(\"Dữ liệu tin nhắn không hợp lệ.\");setHasMore(false);}}catch(err){setError(\"Lỗi khi tải tin nhắn: \"+err.message);console.error(\"Lỗi khi lấy tin nhắn:\",err);setHasMore(false);}finally{setLoading(false);setIsLoadingMore(false);}},[friend]);const loadMoreMessages=useCallback(()=>{if(messages.length===0)return;setIsLoadingMore(true);const firstMessage=messages[0];const before=firstMessage.timestamp.toISOString();fetchMessages(before);},[messages,fetchMessages]);useEffect(()=>{setLoading(true);setIsLoadingMore(false);setHasMore(true);setError(null);setMessages([]);fetchMessages(null);},[friend,fetchMessages]);return{messages,setMessages,loading,isLoadingMore,hasMore,error,loadMoreMessages,fetchMessages};}export default useMessagesHandler;","map":{"version":3,"names":["useState","useEffect","useCallback","axios","useMessagesHandler","friend","messages","setMessages","loading","setLoading","isLoadingMore","setIsLoadingMore","hasMore","setHasMore","error","setError","fetchMessages","before","arguments","length","undefined","id","sender","payload","friendId","limit","console","log","response","post","data","status","transformedMessages","map","msg","_id","text","message_type","content","type","timestamp","Date","image","url","video","file","name","isTemporary","filter","prev","index","self","findIndex","m","localStorage","removeItem","err","message","loadMoreMessages","firstMessage","toISOString"],"sources":["/home/ichigomazone/Vscode/ReactJs/new-ui/frontend/src/components/Chat/MessageHandler/useMessageHandler.js"],"sourcesContent":["import { useState, useEffect, useCallback } from \"react\";\nimport axios from \"axios\";\n\nfunction useMessagesHandler(friend) {\n  const [messages, setMessages] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [error, setError] = useState(null);\n\n  const fetchMessages = useCallback(async (before = null) => {\n    if (!friend || !friend.id || !friend.sender) {\n      setMessages([]);\n      setLoading(false);\n      setHasMore(false);\n      return;\n    }\n\n    try {\n      const payload = {\n        friendId: friend.id,\n        limit: 30,\n      };\n      if (before) {\n        payload.before = before;\n      }\n      \n      console.log('[FetchMessages] Sending payload:', payload); // Log payload\n      const response = await axios.post(\"http://localhost:5000/api/chat/messages/\", payload);\n      console.log('[FetchMessages] Raw response:', response); // Log toàn bộ response\n      console.log('[FetchMessages] Response data:', response.data.data); // Log data\n\n      if (response.status === 200) {\n        console.log(\"API cua message hien thi\", response.data)\n        const transformedMessages = response.data.data\n          .map((msg) => ({\n            id: msg._id,\n            text: msg.message_type === \"text\" && typeof msg.content === \"string\" ? msg.content : \"\",\n            type: msg.sender === friend.sender ? \"sent\" : \"received\",\n            timestamp: new Date(msg.timestamp),\n            image: msg.message_type === \"image\" ? msg.url : null,\n            video: msg.message_type === \"video\" ? msg.url : null,\n            file: msg.message_type === \"file\" ? { name: msg.content, url: msg.url } : null,\n            isTemporary: false,\n          }))\n          .filter((msg) => msg.text || msg.image || msg.video || msg.file);\n\n        setMessages((prev) => {\n          if (before) {\n            return [...transformedMessages, ...prev].filter((msg, index, self) =>\n              index === self.findIndex((m) => m.id === msg.id)\n            );\n          } else {\n            localStorage.removeItem('lastMessageId');\n            return transformedMessages;\n          }\n        });\n\n        setHasMore(transformedMessages.length === 50);\n      } else {\n        setError(\"Dữ liệu tin nhắn không hợp lệ.\");\n        setHasMore(false);\n      }\n    } catch (err) {\n      setError(\"Lỗi khi tải tin nhắn: \" + err.message);\n      console.error(\"Lỗi khi lấy tin nhắn:\", err);\n      setHasMore(false);\n    } finally {\n      setLoading(false);\n      setIsLoadingMore(false);\n    }\n  }, [friend]);\n\n  const loadMoreMessages = useCallback(() => {\n    if (messages.length === 0) return;\n    setIsLoadingMore(true);\n    const firstMessage = messages[0];\n    const before = firstMessage.timestamp.toISOString();\n    fetchMessages(before);\n  }, [messages, fetchMessages]);\n\n  useEffect(() => {\n    setLoading(true);\n    setIsLoadingMore(false);\n    setHasMore(true);\n    setError(null);\n    setMessages([]);\n    fetchMessages(null);\n  }, [friend, fetchMessages]);\n\n  return {\n    messages,\n    setMessages,\n    loading,\n    isLoadingMore,\n    hasMore,\n    error,\n    loadMoreMessages,\n    fetchMessages\n  };\n}\n\nexport default useMessagesHandler;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}